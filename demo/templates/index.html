<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pentaview Stream Viewer</title>
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0B0E11;
            color: #D1D4DC;
            overflow: hidden;
        }
        
        #header {
            background: #131722;
            padding: 12px 20px;
            border-bottom: 1px solid #2A2E39;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        #header h1 {
            font-size: 18px;
            font-weight: 600;
            color: #F23645;
        }
        
        #status {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 12px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #787B86;
        }
        
        .status-dot.connected { background: #089981; }
        .status-dot.connecting { background: #F7931A; animation: pulse 1.5s infinite; }
        .status-dot.error { background: #F23645; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        
        #stats {
            display: flex;
            gap: 20px;
            font-size: 11px;
            color: #787B86;
        }
        
        #chart-container {
            height: calc(100vh - 100px);
            background: #131722;
        }
        
        #legend {
            position: absolute;
            top: 70px;
            left: 20px;
            background: rgba(19, 23, 34, 0.9);
            padding: 12px;
            border-radius: 6px;
            font-size: 11px;
            z-index: 10;
            min-width: 200px;
        }
        
        .legend-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 4px 0;
            padding: 4px 0;
        }
        
        .legend-item:not(:last-child) {
            border-bottom: 1px solid #2A2E39;
        }
        
        .legend-label {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legend-color {
            width: 12px;
            height: 2px;
            border-radius: 1px;
        }
        
        .legend-value {
            font-weight: 600;
            font-variant-numeric: tabular-nums;
        }
        
        .stream-group {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #2A2E39;
        }
        
        .stream-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: #D1D4DC;
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>⚡ Pentaview Stream Viewer</h1>
        <div id="status">
            <div class="status-dot" id="status-dot"></div>
            <span id="status-text">Connecting...</span>
        </div>
        <div id="stats">
            <span id="stat-bars">Bars: 0</span>
            <span id="stat-updates">Updates: 0</span>
            <span id="stat-model">Model: v30s_20251115_20251215</span>
        </div>
    </div>
    
    <div id="chart-container"></div>
    
    <div id="legend">
        <div class="legend-item">
            <div class="legend-label">
                <div class="legend-color" style="background: #089981; height: 12px; width: 4px;"></div>
                <span>Price</span>
            </div>
            <span class="legend-value" id="legend-price">—</span>
        </div>
        
        <div class="stream-group">
            <div class="stream-title">Streams (30s)</div>
            <div class="legend-item">
                <div class="legend-label">
                    <div class="legend-color" style="background: #F23645;"></div>
                    <span>Pressure (σ_P)</span>
                </div>
                <span class="legend-value" id="legend-sigma-p">—</span>
            </div>
            <div class="legend-item">
                <div class="legend-label">
                    <div class="legend-color" style="background: #2962FF;"></div>
                    <span>Momentum (σ_M)</span>
                </div>
                <span class="legend-value" id="legend-sigma-m">—</span>
            </div>
            <div class="legend-item">
                <div class="legend-label">
                    <div class="legend-color" style="background: #089981;"></div>
                    <span>Flow (σ_F)</span>
                </div>
                <span class="legend-value" id="legend-sigma-f">—</span>
            </div>
            <div class="legend-item">
                <div class="legend-label">
                    <div class="legend-color" style="background: #FF9800;"></div>
                    <span>Barrier (σ_B)</span>
                </div>
                <span class="legend-value" id="legend-sigma-b">—</span>
            </div>
            <div class="legend-item">
                <div class="legend-label">
                    <div class="legend-color" style="background: #9C27B0;"></div>
                    <span>Structure (σ_R)</span>
                </div>
                <span class="legend-value" id="legend-sigma-r">—</span>
            </div>
        </div>
    </div>

    <script>
        // Chart setup
        const chartContainer = document.getElementById('chart-container');
        const chart = LightweightCharts.createChart(chartContainer, {
            layout: {
                background: { color: '#131722' },
                textColor: '#D1D4DC',
            },
            grid: {
                vertLines: { color: '#2A2E39' },
                horzLines: { color: '#2A2E39' },
            },
            crosshair: {
                mode: LightweightCharts.CrosshairMode.Normal,
            },
            leftPriceScale: {
                visible: true,
                borderColor: '#2A2E39',
            },
            rightPriceScale: {
                visible: true,
                borderColor: '#2A2E39',
                scaleMargins: { top: 0.1, bottom: 0.1 },
                autoScale: true,
            },
            timeScale: {
                borderColor: '#2A2E39',
                timeVisible: true,
                secondsVisible: false,
            },
        });

        // Candlestick series (left Y-axis)
        const candleSeries = chart.addCandlestickSeries({
            upColor: '#089981',
            downColor: '#F23645',
            borderUpColor: '#089981',
            borderDownColor: '#F23645',
            wickUpColor: '#089981',
            wickDownColor: '#F23645',
            priceScaleId: 'left',
        });

        // Stream series (right Y-axis, -1 to +1)
        const streamSeries = {
            sigma_p: chart.addLineSeries({ color: '#F23645', lineWidth: 2, priceScaleId: 'right', title: 'σ_P' }),
            sigma_m: chart.addLineSeries({ color: '#2962FF', lineWidth: 2, priceScaleId: 'right', title: 'σ_M' }),
            sigma_f: chart.addLineSeries({ color: '#089981', lineWidth: 2, priceScaleId: 'right', title: 'σ_F' }),
            sigma_b: chart.addLineSeries({ color: '#FF9800', lineWidth: 2, priceScaleId: 'right', title: 'σ_B' }),
            sigma_r: chart.addLineSeries({ color: '#9C27B0', lineWidth: 2, priceScaleId: 'right', title: 'σ_R' }),
        };

        // Projection series (right Y-axis, dashed lines)
        const projectionSeries = {
            q10: chart.addLineSeries({ color: 'rgba(255, 152, 0, 0.6)', lineWidth: 1, lineStyle: 2, priceScaleId: 'right', title: 'Q10' }),
            q50: chart.addLineSeries({ color: 'rgba(255, 152, 0, 1.0)', lineWidth: 2, lineStyle: 2, priceScaleId: 'right', title: 'Q50' }),
            q90: chart.addLineSeries({ color: 'rgba(255, 152, 0, 0.6)', lineWidth: 1, lineStyle: 2, priceScaleId: 'right', title: 'Q90' }),
        };

        // Resize chart on window resize
        window.addEventListener('resize', () => {
            chart.applyOptions({ width: chartContainer.clientWidth, height: chartContainer.clientHeight });
        });

        // WebSocket connection
        let ws = null;
        let updateCount = 0;
        let barCount = 0;
        
        // Accumulate data points for each series
        const streamData = {
            sigma_p: [],
            sigma_m: [],
            sigma_f: [],
            sigma_b: [],
            sigma_r: []
        };
        const candleData = [];
        const projectionData = {
            q10: [],
            q50: [],
            q90: []
        };

        function connect() {
            setStatus('connecting', 'Connecting to Gateway...');
            
            // Connect to local WebSocket proxy
            ws = new WebSocket('ws://localhost:5000/ws/pentaview');
            
            ws.onopen = () => {
                setStatus('connected', 'Connected');
                console.log('✓ Connected to Gateway');
            };
            
            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    
                    if (data.error) {
                        setStatus('error', `Error: ${data.error}`);
                        return;
                    }
                    
                    // Extract Pentaview data (wrapped in 'pentaview' key from Gateway)
                    const pentaview = data.pentaview || data;
                    
                    // Handle different message types
                    if (pentaview.candles) {
                        updateCandles(pentaview.candles);
                    }
                    
                    if (pentaview.streams) {
                        updateStreams(pentaview.streams);
                    }
                    
                    if (pentaview.projections) {
                        updateProjections(pentaview.projections);
                    }
                    
                    updateCount++;
                    document.getElementById('stat-updates').textContent = `Updates: ${updateCount}`;
                    
                } catch (error) {
                    console.error('Error parsing message:', error);
                }
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                setStatus('error', 'Connection error');
            };
            
            ws.onclose = () => {
                setStatus('error', 'Disconnected');
                console.log('Disconnected from Gateway. Reconnecting in 3s...');
                setTimeout(connect, 3000);
            };
        }

        function setStatus(state, text) {
            const dot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');
            
            dot.className = `status-dot ${state}`;
            statusText.textContent = text;
        }

        function updateCandles(newCandles) {
            // Append new candles
            for (const candle of newCandles) {
                const exists = candleData.some(c => c.time === candle.time);
                if (!exists) {
                    candleData.push(candle);
                }
            }
            
            candleData.sort((a, b) => a.time - b.time);
            candleSeries.setData(candleData);
            barCount = candleData.length;
            document.getElementById('stat-bars').textContent = `Bars: ${barCount}`;
            
            // Update price legend
            const lastCandle = candleData[candleData.length - 1];
            if (lastCandle) {
                document.getElementById('legend-price').textContent = lastCandle.close.toFixed(2);
            }
        }

        function updateStreams(streams) {
            // streams = { sigma_p: [{time, value}], sigma_m: [...], ... }
            for (const [streamName, newPoints] of Object.entries(streams)) {
                if (streamSeries[streamName] && streamData[streamName]) {
                    // Append new points to accumulated data
                    for (const point of newPoints) {
                        // Avoid duplicates by checking if time already exists
                        const exists = streamData[streamName].some(p => p.time === point.time);
                        if (!exists) {
                            streamData[streamName].push(point);
                        }
                    }
                    
                    // Sort by time and set all data
                    streamData[streamName].sort((a, b) => a.time - b.time);
                    streamSeries[streamName].setData(streamData[streamName]);
                    
                    // Update legend with latest value
                    const lastPoint = streamData[streamName][streamData[streamName].length - 1];
                    if (lastPoint) {
                        const legendId = `legend-${streamName.replace('_', '-')}`;
                        const element = document.getElementById(legendId);
                        if (element) {
                            element.textContent = lastPoint.value.toFixed(3);
                        }
                    }
                }
            }
        }

        function updateProjections(projections) {
            // projections = { q10: [{time, value}], q50: [...], q90: [...] }
            // Note: Projections are forward-looking and should replace, not accumulate
            for (const [quantile, data] of Object.entries(projections)) {
                if (projectionSeries[quantile]) {
                    projectionSeries[quantile].setData(data);
                }
            }
        }

        // Start connection
        connect();
    </script>
</body>
</html>
