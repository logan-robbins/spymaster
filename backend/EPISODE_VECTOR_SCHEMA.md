# Episode Vector Schema (v4.5.0 -  per RESEARCH.md Phase 4.5)

**Path**: `gold/episodes/es_level_episodes/vectors/date=YYYY-MM-DD/episodes.npy`

**Purpose**: 149-dimensional "source of truth" vectors for similarity retrieval and ML training. Vectors are compressed to 32D (Geometry Only) for FAISS storage per Phase 4 calibration.

**Generated By**: `silver_to_gold` pipeline, Stage 2 (ConstructEpisodes)

**Data Flow**:
1. **Bronze → Silver**: `bronze_to_silver` pipeline (stages 0-16) produces Silver features (~142 columns)
2. **Silver → Gold**: `silver_to_gold` pipeline (stages 0-2) produces  episode vectors

**Notation in tables**:
- `B2S.N` = `bronze_to_silver` pipeline, stage N
- `S2G.N` = `silver_to_gold` pipeline, stage N

---

## Section A: Context & Regime (25 dimensions)

**Purpose**: "Where are we?" - Market regime, level structure, gamma exposure  
**Pipeline**: `bronze_to_silver` (stages 1-14)  
**Layer**: Silver features → copied to Gold episode vectors

| Index | Feature | Pipeline.Stage | Description |
|-------|---------|-------|-------------|
| 0 | minutes_since_open | B2S.14 | Minutes elapsed since RTH open (09:30 ET) |
| 1 | bars_since_open | B2S.14 | 1-minute bars since RTH open |
| 2 | atr | B2S.1 | Average True Range (volatility measure) |
| 3 | or_active | B2S.14 | Open Range active flag (1 if >= 15 min since open) |
| 4 | level_stacking_2pt | B2S.11 | Count of nearby levels within 2 points |
| 5 | level_stacking_5pt | B2S.11 | Count of nearby levels within 5 points |
| 6 | level_stacking_10pt | B2S.11 | Count of nearby levels within 10 points |
| 7 | dist_to_pm_high_atr | B2S.11 | Distance to Premarket High (ATR-normalized) |
| 8 | dist_to_pm_low_atr | B2S.11 | Distance to Premarket Low (ATR-normalized) |
| 9 | dist_to_or_high_atr | B2S.11 | Distance to Open Range High (ATR-normalized) |
| 10 | dist_to_or_low_atr | B2S.11 | Distance to Open Range Low (ATR-normalized) |
| 11 | dist_to_sma_90_atr | B2S.11 | Distance to SMA(90) (ATR-normalized) |
| 12 | dist_to_ema_20_atr | B2S.11 | Distance to EMA(20) (ATR-normalized) |
| 13 | prior_touches | B2S.14 | Prior interaction count at this level (RTH) |
| 14 | attempt_index | B2S.14 | Touch attempt within current cluster |
| 15 | time_since_last_touch_sec | B2S.14 | Seconds since previous touch at this level |
| 16 | gamma_exposure | B2S.7 | Net dealer gamma exposure near level |
| 17 | fuel_effect_encoded | B2S.7 | Gamma fuel effect: AMPLIFY=-1, NEUTRAL=0, DAMPEN=1 |
| 18 | gex_ratio | B2S.12 | GEX above/below ratio (max strike band) |
| 19 | gex_asymmetry | B2S.12 | GEX above minus below (max strike band) |
| 20 | net_gex_2strike | B2S.12 | Net GEX within ±2 strikes |
| 21 | gex_above_1strike | B2S.12 | Dealer GEX above level (+1 strike band) |
| 22 | gex_below_1strike | B2S.12 | Dealer GEX below level (-1 strike band) |
| 23 | call_gex_above_2strike | B2S.12 | Call dealer GEX above level (+2 strike band) |
| 24 | put_gex_below_2strike | B2S.12 | Put dealer GEX below level (-2 strike band) |

---

## Section B: Multi-Scale Dynamics (40 dimensions)

**Purpose**: "How fast are we moving?" - Multi-window kinematics (1,2,3,5,10,20min) validated via 10s high-res bars  
**Pipeline**: `bronze_to_silver` (stages 8-14)  
**Layer**: Silver features → copied to Gold episode vectors

| Index | Feature | Pipeline.Stage | Description |
|-------|---------|-------|-------------|
| 25 | velocity_1min | B2S.8 | Level-frame velocity over 1min window |
| 26 | velocity_2min | B2S.8 | Level-frame velocity over 2min window |
| 27 | velocity_3min | B2S.8 | Level-frame velocity over 3min window |
| 28 | velocity_5min | B2S.8 | Level-frame velocity over 5min window |
| 29 | velocity_10min | B2S.8 | Level-frame velocity over 10min window |
| 30 | velocity_20min | B2S.8 | Level-frame velocity over 20min window |
| 31 | acceleration_1min | B2S.8 | Level-frame acceleration over 1min window |
| 32 | acceleration_2min | B2S.8 | Level-frame acceleration over 2min window |
| 33 | acceleration_3min | B2S.8 | Level-frame acceleration over 3min window |
| 34 | acceleration_5min | B2S.8 | Level-frame acceleration over 5min window |
| 35 | acceleration_10min | B2S.8 | Level-frame acceleration over 10min window |
| 36 | acceleration_20min | B2S.8 | Level-frame acceleration over 20min window |
| 37 | jerk_1min | B2S.8 | Level-frame jerk over 1min window |
| 38 | jerk_2min | B2S.8 | Level-frame jerk over 2min window |
| 39 | jerk_3min | B2S.8 | Level-frame jerk over 3min window |
| 40 | jerk_5min | B2S.8 | Level-frame jerk over 5min window |
| 41 | vacuum_duration_ms | B2S.micro | Duration (ms) liquidity < threshold (Vacuum) **(NEW)** |
| 42 | replenishment_latency_ms | B2S.micro | Time (ms) to refill after trade **(NEW)** |
| 43 | momentum_trend_1min | B2S.8 | Momentum trend proxy over 1min window **(NEW)** |
| 44 | momentum_trend_2min | B2S.8 | Momentum trend proxy over 2min window **(NEW)** |
| 45 | momentum_trend_3min | B2S.8 | Momentum trend proxy over 3min window |
| 46 | momentum_trend_5min | B2S.8 | Momentum trend proxy over 5min window |
| 47 | momentum_trend_10min | B2S.8 | Momentum trend proxy over 10min window |
| 48 | momentum_trend_20min | B2S.8 | Momentum trend proxy over 20min window |
| 49 | ofi_30s | B2S.9 | Integrated Order Flow Imbalance over 30s window |
| 50 | ofi_60s | B2S.9 | Integrated Order Flow Imbalance over 60s window |
| 51 | ofi_120s | B2S.9 | Integrated Order Flow Imbalance over 120s window |
| 52 | ofi_300s | B2S.9 | Integrated Order Flow Imbalance over 300s window |
| 53 | ofi_near_level_30s | B2S.9 | Mean OFI near level over 30s window |
| 54 | ofi_near_level_60s | B2S.9 | Mean OFI near level over 60s window |
| 55 | ofi_near_level_120s | B2S.9 | Mean OFI near level over 120s window |
| 56 | ofi_near_level_300s | B2S.9 | Mean OFI near level over 300s window |
| 57 | ofi_acceleration | B2S.9 | OFI acceleration (30s vs 120s ratio) |
| 58 | barrier_delta_1min | B2S.10 | Barrier depth change over 1min window |
| 59 | barrier_delta_2min | B2S.10 | Barrier depth change over 2min window **(NEW)** |
| 60 | barrier_delta_3min | B2S.10 | Barrier depth change over 3min window |
| 61 | barrier_delta_5min | B2S.10 | Barrier depth change over 5min window |
| 62 | approach_velocity | B2S.14 | Approach velocity toward level |
| 63 | approach_bars | B2S.14 | Consecutive bars approaching level |
| 64 | approach_distance_atr | B2S.14 | Approach distance (ATR-normalized) |

---

## Section C: Micro-History (35 dimensions)

**Purpose**: "What just happened?" - Last 5 bars at 30s cadence (2.5 min history)  
**Pipeline**: `silver_to_gold` (stage 2: ConstructEpisodes)  
**Layer**: Gold only - constructed from state table lookback  
**Note**: These features DO NOT exist in Silver - they are derived during episode construction

| Index | Feature | Pipeline.Stage | Description |
|-------|---------|-------|-------------|
| 65 | d_atr_t0 | S2G.2 | Distance to level (ATR) at T-0 (anchor) |
| 66 | d_atr_t1 | S2G.2 | Distance to level (ATR) at T-1 (30s ago) |
| 67 | d_atr_t2 | S2G.2 | Distance to level (ATR) at T-2 (60s ago) |
| 68 | d_atr_t3 | S2G.2 | Distance to level (ATR) at T-3 (90s ago) |
| 69 | d_atr_t4 | S2G.2 | Distance to level (ATR) at T-4 (120s ago) |
| 70 | tape_imbalance_t0 | S2G.2 | Tape buy-sell imbalance at T-0 |
| 71 | tape_imbalance_t1 | S2G.2 | Tape buy-sell imbalance at T-1 |
| 72 | tape_imbalance_t2 | S2G.2 | Tape buy-sell imbalance at T-2 |
| 73 | tape_imbalance_t3 | S2G.2 | Tape buy-sell imbalance at T-3 |
| 74 | tape_imbalance_t4 | S2G.2 | Tape buy-sell imbalance at T-4 |
| 75 | tape_velocity_t0 | S2G.2 | Tape trade velocity at T-0 |
| 76 | tape_velocity_t1 | S2G.2 | Tape trade velocity at T-1 |
| 77 | tape_velocity_t2 | S2G.2 | Tape trade velocity at T-2 |
| 78 | tape_velocity_t3 | S2G.2 | Tape trade velocity at T-3 |
| 79 | tape_velocity_t4 | S2G.2 | Tape trade velocity at T-4 |
| 80 | ofi_60s_t0 | S2G.2 | 60s OFI at T-0 |
| 81 | ofi_60s_t1 | S2G.2 | 60s OFI at T-1 |
| 82 | ofi_60s_t2 | S2G.2 | 60s OFI at T-2 |
| 83 | ofi_60s_t3 | S2G.2 | 60s OFI at T-3 |
| 84 | ofi_60s_t4 | S2G.2 | 60s OFI at T-4 |
| 85 | barrier_delta_liq_log_t0 | S2G.2 | Log-transformed barrier liquidity delta at T-0 |
| 86 | barrier_delta_liq_log_t1 | S2G.2 | Log-transformed barrier liquidity delta at T-1 |
| 87 | barrier_delta_liq_log_t2 | S2G.2 | Log-transformed barrier liquidity delta at T-2 |
| 88 | barrier_delta_liq_log_t3 | S2G.2 | Log-transformed barrier liquidity delta at T-3 |
| 89 | barrier_delta_liq_log_t4 | S2G.2 | Log-transformed barrier liquidity delta at T-4 |
| 90 | wall_ratio_log_t0 | S2G.2 | Log-transformed wall ratio at T-0 |
| 91 | wall_ratio_log_t1 | S2G.2 | Log-transformed wall ratio at T-1 |
| 92 | wall_ratio_log_t2 | S2G.2 | Log-transformed wall ratio at T-2 |
| 93 | wall_ratio_log_t3 | S2G.2 | Log-transformed wall ratio at T-3 |
| 94 | wall_ratio_log_t4 | S2G.2 | Log-transformed wall ratio at T-4 |
| 95 | gamma_exposure_t0 | S2G.2 | Gamma exposure at T-0 |
| 96 | gamma_exposure_t1 | S2G.2 | Gamma exposure at T-1 |
| 97 | gamma_exposure_t2 | S2G.2 | Gamma exposure at T-2 |
| 98 | gamma_exposure_t3 | S2G.2 | Gamma exposure at T-3 |
| 99 | gamma_exposure_t4 | S2G.2 | Gamma exposure at T-4 |

---

## Section D: Derived Physics (13 dimensions)

**Purpose**: "How 'heavy' is the move?" - Force/Mass ratios + Market Tide (Phase 4.5)  
**Pipeline**: `bronze_to_silver` (stages 7, 13)  
**Layer**: Silver features → copied to Gold episode vectors

| Index | Feature | Pipeline.Stage | Description |
|-------|---------|-------|-------------|
| 100 | predicted_accel | B2S.13 | Predicted acceleration from F=ma proxy |
| 101 | accel_residual | B2S.13 | Actual - predicted acceleration residual |
| 102 | force_mass_ratio | B2S.13 | Ratio of Order Flow (force) to Limit Book (mass) |
| 103 | mass_proxy | B2S.13 | Barrier depth proxy for inertia |
| 104 | force_proxy | B2S.13 | OFI proxy for momentum force |
| 105 | barrier_state_encoded | B2S.7 | Barrier state: STRONG_SUPPORT=2, WEAK_SUPPORT=1, NEUTRAL=0, WEAK_RESISTANCE=-1, STRONG_RESISTANCE=-2 |
| 106 | barrier_replenishment_ratio | B2S.7 | Barrier replenishment rate |
| 107 | sweep_detected | B2S.7 | Sweep detection flag (0/1) |
| 108 | tape_log_ratio | B2S.13 | Log(buy_vol / sell_vol) |
| 109 | tape_log_total | B2S.13 | Log(buy_vol + sell_vol) |
| 110 | flow_alignment | B2S.13 | OFI aligned with approach direction (OFI × approach_sign) |
| 111 | call_tide | B2S.7 | **Market Tide**: Net premium flow into Calls - Phase 4.5 **(NEW)** |
| 112 | put_tide | B2S.7 | **Market Tide**: Net premium flow into Puts - Phase 4.5 **(NEW)** |

---

## Section E: Online Trends (4 dimensions)

**Purpose**: "Is pressure building?" - Rolling trend slopes within touch cluster  
**Pipeline**: `bronze_to_silver` (stage 14: ComputeApproachFeatures)  
**Layer**: Silver features → copied to Gold episode vectors

| Index | Feature | Pipeline.Stage | Description |
|-------|---------|-------|-------------|
| 113 | barrier_replenishment_trend | B2S.14 | Trend in barrier replenishment ratio within cluster |
| 114 | barrier_delta_liq_trend | B2S.14 | Trend in barrier liquidity delta within cluster |
| 115 | tape_velocity_trend | B2S.14 | Trend in tape velocity within cluster |
| 116 | tape_imbalance_trend | B2S.14 | Trend in tape imbalance within cluster |

---

## Section F: Trajectory Basis (32 dimensions)

**Purpose**: "What does the path look like?" - DCT frequency encoding of 20-min trajectory  
**THIS IS THE MOST ROBUST SIGNAL** (Phase 4: 71.8% accuracy, ECE 2.40%)  
**Pipeline**: `silver_to_gold` (stage 2: ConstructEpisodes)  
**Layer**: Gold only - DCT transform on 40-bar trajectory window (30s cadence = 20 minutes)  
**Note**: These features DO NOT exist in Silver - they are computed during episode construction

| Index | Feature | Pipeline.Stage | Description |
|-------|---------|-------|-------------|
| 117 | dct_d_atr_c0 | S2G.2 | DCT coefficient 0 of distance trajectory (DC component) |
| 118 | dct_d_atr_c1 | S2G.2 | DCT coefficient 1 of distance trajectory |
| 119 | dct_d_atr_c2 | S2G.2 | DCT coefficient 2 of distance trajectory |
| 120 | dct_d_atr_c3 | S2G.2 | DCT coefficient 3 of distance trajectory |
| 121 | dct_d_atr_c4 | S2G.2 | DCT coefficient 4 of distance trajectory |
| 122 | dct_d_atr_c5 | S2G.2 | DCT coefficient 5 of distance trajectory |
| 123 | dct_d_atr_c6 | S2G.2 | DCT coefficient 6 of distance trajectory |
| 124 | dct_d_atr_c7 | S2G.2 | DCT coefficient 7 of distance trajectory |
| 125 | dct_ofi_60s_c0 | S2G.2 | DCT coefficient 0 of OFI trajectory |
| 126 | dct_ofi_60s_c1 | S2G.2 | DCT coefficient 1 of OFI trajectory |
| 127 | dct_ofi_60s_c2 | S2G.2 | DCT coefficient 2 of OFI trajectory |
| 128 | dct_ofi_60s_c3 | S2G.2 | DCT coefficient 3 of OFI trajectory |
| 129 | dct_ofi_60s_c4 | S2G.2 | DCT coefficient 4 of OFI trajectory |
| 130 | dct_ofi_60s_c5 | S2G.2 | DCT coefficient 5 of OFI trajectory |
| 131 | dct_ofi_60s_c6 | S2G.2 | DCT coefficient 6 of OFI trajectory |
| 132 | dct_ofi_60s_c7 | S2G.2 | DCT coefficient 7 of OFI trajectory |
| 133 | dct_barrier_delta_liq_log_c0 | S2G.2 | DCT coefficient 0 of barrier liquidity trajectory |
| 134 | dct_barrier_delta_liq_log_c1 | S2G.2 | DCT coefficient 1 of barrier liquidity trajectory |
| 135 | dct_barrier_delta_liq_log_c2 | S2G.2 | DCT coefficient 2 of barrier liquidity trajectory |
| 136 | dct_barrier_delta_liq_log_c3 | S2G.2 | DCT coefficient 3 of barrier liquidity trajectory |
| 137 | dct_barrier_delta_liq_log_c4 | S2G.2 | DCT coefficient 4 of barrier liquidity trajectory |
| 138 | dct_barrier_delta_liq_log_c5 | S2G.2 | DCT coefficient 5 of barrier liquidity trajectory |
| 139 | dct_barrier_delta_liq_log_c6 | S2G.2 | DCT coefficient 6 of barrier liquidity trajectory |
| 140 | dct_barrier_delta_liq_log_c7 | S2G.2 | DCT coefficient 7 of barrier liquidity trajectory |
| 141 | dct_tape_imbalance_c0 | S2G.2 | DCT coefficient 0 of tape imbalance trajectory |
| 142 | dct_tape_imbalance_c1 | S2G.2 | DCT coefficient 1 of tape imbalance trajectory |
| 143 | dct_tape_imbalance_c2 | S2G.2 | DCT coefficient 2 of tape imbalance trajectory |
| 144 | dct_tape_imbalance_c3 | S2G.2 | DCT coefficient 3 of tape imbalance trajectory |
| 145 | dct_tape_imbalance_c4 | S2G.2 | DCT coefficient 4 of tape imbalance trajectory |
| 146 | dct_tape_imbalance_c5 | S2G.2 | DCT coefficient 5 of tape imbalance trajectory |
| 147 | dct_tape_imbalance_c6 | S2G.2 | DCT coefficient 6 of tape imbalance trajectory |
| 148 | dct_tape_imbalance_c7 | S2G.2 | DCT coefficient 7 of tape imbalance trajectory |

---

## Compression for FAISS Storage

**Source of Truth**:  vectors stored in `gold/episodes/es_level_episodes/vectors/date=YYYY-MM-DD/episodes.npy`

**FAISS Storage**: 32D compressed vectors (Geometry Only - Section F indices 117-148)

**Compression Strategy**: `geometry_only` per Phase 4 calibration breakthrough

**Compressor Location**: `gold/indices/es_level_indices/compressor.pkl`