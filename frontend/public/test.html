<!DOCTYPE html>
<html>

<head>
    <title>HUD API Test</title>
    <style>
        body {
            background: #0a0a0f;
            color: #fff;
            font-family: monospace;
            padding: 20px;
        }

        button {
            padding: 10px 20px;
            margin: 10px;
            cursor: pointer;
        }

        pre {
            background: #1a1a2e;
            padding: 15px;
            overflow: auto;
            max-height: 400px;
        }

        .success {
            color: #00ff88;
        }

        .error {
            color: #ff4466;
        }
    </style>
</head>

<body>
    <h1>HUD API Test</h1>
    <button onclick="testHealth()">Test Health</button>
    <button onclick="testGex()">Test GEX Data</button>
    <div id="output"></div>

    <script type="module">
        // Import Apache Arrow from CDN
        import { tableFromIPC } from 'https://cdn.jsdelivr.net/npm/apache-arrow@18.1.0/+esm';

        window.testHealth = async function () {
            const out = document.getElementById('output');
            try {
                const res = await fetch('http://localhost:8000/health');
                const data = await res.json();
                out.innerHTML = `<pre class="success">Health: ${JSON.stringify(data, null, 2)}</pre>`;
            } catch (e) {
                out.innerHTML = `<pre class="error">Error: ${e.message}</pre>`;
            }
        };

        window.testGex = async function () {
            const out = document.getElementById('output');
            out.innerHTML = '<pre>Loading GEX data...</pre>';

            try {
                const res = await fetch('http://localhost:8000/v1/hud/surfaces?symbol=ESH6&dt=2026-01-06&surface=gex');

                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}: ${await res.text()}`);
                }

                const buffer = await res.arrayBuffer();
                console.log('Buffer size:', buffer.byteLength);

                const table = tableFromIPC(buffer);
                console.log('Table loaded:', table.numRows, 'rows');

                // Show first 5 rows
                const rows = [];
                for (let i = 0; i < Math.min(5, table.numRows); i++) {
                    const row = table.get(i);
                    rows.push({
                        strike_points: row?.strike_points,
                        underlying_spot_ref: row?.underlying_spot_ref,
                        gex: row?.gex,
                        gex_abs: row?.gex_abs,
                    });
                }

                out.innerHTML = `
          <pre class="success">
Loaded ${table.numRows} rows from GEX surface

Headers: ${response.headers.get('X-HUD-Rows')} rows

Sample rows:
${JSON.stringify(rows, null, 2)}
          </pre>
        `;

            } catch (e) {
                console.error('Full error:', e);
                out.innerHTML = `<pre class="error">Error: ${e.message}\n\nStack: ${e.stack}</pre>`;
            }
        };
    </script>
</body>

</html>