{
    "equity_mbo": {
        "_metadata": {
            "product_type": "Equity order book (QQQ)",
            "data_source": "Databento MBO schema (Market By Order)",
            "data_format_note": "Full order book reconstruction from individual order events",
            "price_bucketing": "$0.50 intervals (BUCKET_INT = 500_000_000)",
            "grid_range": "+/- $50 from spot (100 buckets each side, rel_ticks [-100, 100])",
            "validated_dates": ["2026-01-08", "2026-01-16", "2026-01-27"],
            "validation_status": "PASS (all formulas verified 2026-02-01)"
        },
        "bronze": {
            "BronzeIngestEquityMbo": {
                "_description": "Normalizes raw Databento MBO events for equity symbols.",
                "_source_file": "backend/src/data_eng/stages/bronze/equity_mbo/ingest.py",
                "_contract": "backend/src/data_eng/contracts/bronze/equity_mbo/mbo.avsc",
                "_session_window": "09:30-09:40 ET (dev), full day in production",
                "ts_event": {
                    "type": "int64",
                    "unit": "nanoseconds since Unix epoch (UTC)",
                    "built_from": ["raw.market_by_order_dbn.ts_event"],
                    "transformation_steps": [
                        "Cast to int64",
                        "Filter to session window"
                    ]
                },
                "price": {
                    "type": "int64",
                    "unit": "price * 1e9 (fixed-point, 9 decimal places)",
                    "built_from": ["raw.market_by_order_dbn.price"],
                    "transformation_steps": [
                        "Cast to int64",
                        "Handle NULL_PRICE (replace with 0 if action is C/F)"
                    ]
                },
                "size": {
                    "type": "int64",
                    "unit": "shares",
                    "built_from": ["raw.market_by_order_dbn.size"],
                    "transformation_steps": ["Cast to int64"]
                },
                "action": {
                    "type": "string",
                    "values": ["A", "C", "M", "T", "F", "R", "N"],
                    "built_from": ["raw.market_by_order_dbn.action"],
                    "transformation_steps": ["Pass through"]
                },
                "side": {
                    "type": "string",
                    "values": ["A", "B"],
                    "built_from": ["raw.market_by_order_dbn.side"],
                    "transformation_steps": ["Pass through"]
                },
                "order_id": {
                    "type": "int64",
                    "built_from": ["raw.market_by_order_dbn.order_id"],
                    "transformation_steps": ["Cast to int64"]
                },
                "flags": {
                    "type": "int64",
                    "built_from": ["raw.market_by_order_dbn.flags"],
                    "transformation_steps": ["Cast to int64"]
                },
                "instrument_id": {
                    "type": "int64",
                    "built_from": ["raw.market_by_order_dbn.instrument_id"],
                    "transformation_steps": ["Cast to int64"]
                }
            }
        },
        "silver": {
            "SilverComputeEquityBookStates1s": {
                "_description": "Reconstructs order book from MBO events, emits 1s BBO snapshots and bucketed depth/flow.",
                "_source_file": "backend/src/data_eng/stages/silver/equity_mbo/compute_book_states_1s.py",
                "_engine": "backend/src/data_eng/stages/silver/equity_mbo/book_engine.py",
                "_warmup_period": "6 hours before output window to capture resting liquidity",
                "_output_window": "09:30-09:40 ET (dev)",
                "book_snapshot_1s": {
                    "_contract": "backend/src/data_eng/contracts/silver/equity_mbo/book_snapshot_1s.avsc",
                    "_grain": "1 second",
                    "_row_count_expected": "~600 rows per day (10-minute dev window)",
                    "window_start_ts_ns": {
                        "type": "int64",
                        "unit": "nanoseconds since Unix epoch",
                        "derivation": "floor(ts_event / 1e9) * 1e9"
                    },
                    "window_end_ts_ns": {
                        "type": "int64",
                        "unit": "nanoseconds since Unix epoch",
                        "derivation": "window_start_ts_ns + 1e9"
                    },
                    "best_bid_price_int": {
                        "type": "int64",
                        "unit": "price * 1e9",
                        "derivation": "max(price) where side='B' and qty > 0 at window_end"
                    },
                    "best_bid_qty": {
                        "type": "int64",
                        "unit": "shares",
                        "derivation": "sum(qty) at best_bid_price at window_end"
                    },
                    "best_ask_price_int": {
                        "type": "int64",
                        "unit": "price * 1e9",
                        "derivation": "min(price) where side='A' and qty > 0 at window_end"
                    },
                    "best_ask_qty": {
                        "type": "int64",
                        "unit": "shares",
                        "derivation": "sum(qty) at best_ask_price at window_end"
                    },
                    "mid_price": {
                        "type": "double",
                        "unit": "dollars",
                        "derivation": "(best_bid_price_int + best_ask_price_int) * 0.5 * 1e-9"
                    },
                    "mid_price_int": {
                        "type": "int64",
                        "unit": "price * 1e9",
                        "derivation": "round((best_bid_price_int + best_ask_price_int) * 0.5)"
                    },
                    "last_trade_price_int": {
                        "type": "int64",
                        "unit": "price * 1e9",
                        "derivation": "most recent action='T' price in window (carry-forward)"
                    },
                    "spot_ref_price_int": {
                        "type": "int64",
                        "unit": "price * 1e9",
                        "derivation": "rounded to $0.50 bucket: round(last_trade or mid / BUCKET_INT) * BUCKET_INT"
                    },
                    "book_valid": {
                        "type": "boolean",
                        "derivation": "True unless snapshot/clear event occurred"
                    }
                },
                "depth_and_flow_1s": {
                    "_contract": "backend/src/data_eng/contracts/silver/equity_mbo/depth_and_flow_1s.avsc",
                    "_description": "Bucketed market depth and order flow per $0.50 price bucket.",
                    "_grain": "1 second x $0.50 bucket x side",
                    "_row_count_expected": "~120k rows per day (600 windows × 100 buckets × 2 sides)",
                    "_bucket_size": "$0.50 (BUCKET_INT = 500_000_000)",
                    "_grid_range": "+/- $50 from spot (100 buckets each side)",
                    "window_start_ts_ns": {
                        "type": "int64",
                        "unit": "nanoseconds since Unix epoch"
                    },
                    "window_end_ts_ns": {
                        "type": "int64",
                        "unit": "nanoseconds since Unix epoch"
                    },
                    "price_int": {
                        "type": "int64",
                        "unit": "price * 1e9 (bucketed to $0.50)",
                        "derivation": "_bucket_price(raw_price, spot_ref, BUCKET_INT)"
                    },
                    "side": {
                        "type": "string",
                        "values": ["A", "B"],
                        "description": "A=ask, B=bid"
                    },
                    "spot_ref_price_int": {
                        "type": "int64",
                        "unit": "price * 1e9",
                        "derivation": "from book_snapshot_1s at window_start"
                    },
                    "rel_ticks": {
                        "type": "int32",
                        "derivation": "(price_int - spot_ref_price_int) / BUCKET_INT",
                        "range": "[-100, 100]",
                        "note": "Spot-anchored coordinate in $0.50 buckets"
                    },
                    "rel_ticks_side": {
                        "type": "int32",
                        "derivation": "(price_int - best_bid_or_ask_bucket) / BUCKET_INT",
                        "note": "BBO-anchored coordinate (bid side uses best_bid, ask side uses best_ask)"
                    },
                    "depth_qty_start": {
                        "type": "double",
                        "unit": "shares",
                        "derivation": "depth_qty_end - add_qty + pull_qty + fill_qty",
                        "constraint": ">= 0 (clamped)"
                    },
                    "depth_qty_end": {
                        "type": "double",
                        "unit": "shares",
                        "derivation": "sum(order.qty) at bucket at window_end"
                    },
                    "add_qty": {
                        "type": "double",
                        "unit": "shares",
                        "derivation": "sum(size) for action='A' events in bucket in window"
                    },
                    "pull_qty": {
                        "type": "double",
                        "unit": "shares",
                        "derivation": "sum(qty) for action='C' or 'M' (price change) events in bucket"
                    },
                    "depth_qty_rest": {
                        "type": "double",
                        "unit": "shares",
                        "derivation": "sum(order.qty) where order age > 500ms at window_end"
                    },
                    "pull_qty_rest": {
                        "type": "double",
                        "unit": "shares",
                        "derivation": "sum(qty) from cancelled orders that were resting > 500ms"
                    },
                    "fill_qty": {
                        "type": "double",
                        "unit": "shares",
                        "derivation": "sum(size) for action='F' events in bucket"
                    },
                    "window_valid": {
                        "type": "boolean",
                        "derivation": "book_valid AND no snapshot in window"
                    }
                }
            }
        },
        "gold": {
            "GoldComputeEquityPhysicsSurface1s": {
                "_description": "Computes intensity features from depth/flow for physics simulation.",
                "_inputs": [
                    "silver.equity_mbo.book_snapshot_1s",
                    "silver.equity_mbo.depth_and_flow_1s"
                ],
                "_contract": "backend/src/data_eng/contracts/gold/equity_mbo/physics_surface_1s.avsc",
                "physics_surface_1s": {
                    "rel_ticks_side": {
                        "type": "int32",
                        "derivation": "Pass through from silver"
                    },
                    "add_intensity": {
                        "type": "double",
                        "derivation": "add_qty / (depth_qty_start + 1.0)"
                    },
                    "fill_intensity": {
                        "type": "double",
                        "derivation": "fill_qty / (depth_qty_start + 1.0)"
                    },
                    "pull_intensity": {
                        "type": "double",
                        "derivation": "pull_qty / (depth_qty_start + 1.0)"
                    },
                    "liquidity_velocity": {
                        "type": "double",
                        "derivation": "add_intensity - pull_intensity - fill_intensity",
                        "note": "Net change in liquidity at bucket"
                    }
                }
            }
        }
    },
    "equity_option_cmbp_1": {
        "_metadata": {
            "product_type": "0DTE equity options (QQQ)",
            "data_source": "Databento CMBP-1 schema (Consolidated Market By Price level 1)",
            "data_format_note": "CMBP-1 is pre-aggregated by price level (BBO only), unlike MBO which has individual orders. fill_qty and pull_qty_rest are always 0.",
            "strike_bucketing": "$1 intervals (vs $5 for ES futures options); rel_ticks aligned to even values (multiples of 2)",
            "validated_dates": ["2026-01-07", "2026-01-09", "2026-01-15", "2026-01-16", "2026-01-27"],
            "validation_status": "PASS (all formulas verified 2026-02-01)"
        },
        "bronze": {
            "BronzeIngestEquityOptionCmbp1": {
                "_description": "Normalizes Databento CMBP-1 (consolidated BBO) for equity options.",
                "_source_file": "backend/src/data_eng/stages/bronze/equity_option_cmbp_1/ingest.py",
                "_contract": "backend/src/data_eng/contracts/bronze/equity_option_cmbp_1/cmbp_1.avsc",
                "_filters": "0DTE options only (expiration == session_date)",
                "_row_count_expected": "~20-30M rows per day (all QQQ 0DTE option BBO updates)",
                "_data_lineage": {
                    "raw_source": "lake/raw/source=databento/product_type=equity_option_cmbp_1/symbol=QQQ/table=cmbp_1/*.dbn",
                    "definition_source": "Parsed from OPRA symbol format (QQQ   YYMMDDCP00SSSSS000)"
                },
                "ts_event": {
                    "type": "int64",
                    "unit": "nanoseconds since Unix epoch (UTC)",
                    "built_from": ["raw.cmbp_1.ts_event"]
                },
                "ts_recv": {
                    "type": "int64",
                    "unit": "nanoseconds since Unix epoch (UTC)",
                    "built_from": ["raw.cmbp_1.ts_recv"]
                },
                "publisher_id": {
                    "type": "int64",
                    "built_from": ["raw.cmbp_1.publisher_id"]
                },
                "instrument_id": {
                    "type": "int64",
                    "built_from": ["raw.cmbp_1.instrument_id"]
                },
                "bid_px_00": {
                    "type": "int64",
                    "unit": "price * 1e9",
                    "built_from": ["raw.cmbp_1.bid_px_00"],
                    "note": "NULL_PRICE (int64.max) replaced with 0"
                },
                "ask_px_00": {
                    "type": "int64",
                    "unit": "price * 1e9",
                    "built_from": ["raw.cmbp_1.ask_px_00"],
                    "note": "NULL_PRICE (int64.max) replaced with 0"
                },
                "bid_sz_00": {
                    "type": "int64",
                    "unit": "contracts",
                    "built_from": ["raw.cmbp_1.bid_sz_00"]
                },
                "ask_sz_00": {
                    "type": "int64",
                    "unit": "contracts",
                    "built_from": ["raw.cmbp_1.ask_sz_00"]
                },
                "underlying": {
                    "type": "string",
                    "derivation": "Parsed from OPRA symbol chars[0:6].strip()"
                },
                "right": {
                    "type": "string",
                    "values": ["C", "P"],
                    "derivation": "Parsed from OPRA symbol char[12]"
                },
                "strike": {
                    "type": "int64",
                    "unit": "price * 1e9",
                    "derivation": "Parsed from OPRA symbol chars[13:21] * 1e6 (OPRA uses 1e3 scale)"
                },
                "expiration": {
                    "type": "int64",
                    "unit": "nanoseconds since Unix epoch (UTC)",
                    "derivation": "Parsed from OPRA symbol chars[6:12] (YYMMDD)"
                }
            }
        },
        "silver": {
            "SilverComputeEquityOptionBookStates1s": {
                "_description": "Aggregates CMBP-1 BBO updates to 1s snapshots and strike-bucketed depth/flow.",
                "_source_file": "backend/src/data_eng/stages/silver/equity_option_cmbp_1/compute_book_states_1s.py",
                "_engine": "backend/src/data_eng/stages/silver/equity_option_cmbp_1/cmbp1_book_engine.py",
                "_data_lineage": {
                    "inputs": [
                        "bronze.equity_option_cmbp_1.cmbp_1 (CMBP-1 BBO updates)",
                        "silver.equity_mbo.book_snapshot_1s (underlying spot reference)"
                    ],
                    "outputs": [
                        "silver.equity_option_cmbp_1.book_snapshot_1s",
                        "silver.equity_option_cmbp_1.depth_and_flow_1s"
                    ]
                },
                "_output_window": "09:30-10:30 ET (first hour)",
                "book_snapshot_1s": {
                    "_contract": "backend/src/data_eng/contracts/silver/equity_option_cmbp_1/book_snapshot_1s.avsc",
                    "_grain": "1 second x instrument",
                    "_row_count_expected": "~80-90k rows per day (599 windows x 135-150 instruments)",
                    "window_start_ts_ns": {
                        "type": "int64",
                        "unit": "nanoseconds since Unix epoch",
                        "derivation": "window_end_ts_ns - 1e9"
                    },
                    "window_end_ts_ns": {
                        "type": "int64",
                        "unit": "nanoseconds since Unix epoch",
                        "derivation": "floor(ts_event / 1e9) * 1e9 + 1e9"
                    },
                    "instrument_id": {
                        "type": "int64",
                        "derivation": "Pass through from bronze.cmbp_1"
                    },
                    "right": {
                        "type": "string",
                        "values": ["C", "P"],
                        "derivation": "Joined from bronze.cmbp_1"
                    },
                    "strike_price_int": {
                        "type": "int64",
                        "unit": "price * 1e9",
                        "derivation": "Joined from bronze.cmbp_1"
                    },
                    "bid_price_int": {
                        "type": "int64",
                        "unit": "price * 1e9",
                        "derivation": "Last state.bid_price_int per instrument at window_end"
                    },
                    "ask_price_int": {
                        "type": "int64",
                        "unit": "price * 1e9",
                        "derivation": "Last state.ask_price_int per instrument at window_end"
                    },
                    "mid_price_int": {
                        "type": "double",
                        "unit": "price * 1e9",
                        "derivation": "(bid_price_int + ask_price_int) * 0.5"
                    },
                    "mid_price": {
                        "type": "double",
                        "unit": "dollars",
                        "derivation": "mid_price_int * 1e-9"
                    },
                    "spot_ref_price_int": {
                        "type": "int64",
                        "unit": "price * 1e9",
                        "derivation": "Joined from silver.equity_mbo.book_snapshot_1s by window_end_ts_ns"
                    },
                    "book_valid": {
                        "type": "boolean",
                        "derivation": "True (always valid for BBO-only data)"
                    }
                },
                "depth_and_flow_1s": {
                    "_contract": "backend/src/data_eng/contracts/silver/equity_option_cmbp_1/depth_and_flow_1s.avsc",
                    "_description": "Option depth/flow bucketed to $1 strike grid centered on spot.",
                    "_grain": "1 second x $1 strike bucket x right x side",
                    "_strike_grid": "+/- $25 from spot (51 strike buckets x 2 rights x 2 sides = 204 rows per window)",
                    "_row_count_expected": "122,400 rows per day (600 windows x 51 strikes x 2 rights x 2 sides)",
                    "_cmbp1_vs_mbo_note": "CMBP-1 provides aggregated BBO only, so pull_qty_rest and fill_qty are always 0",
                    "window_start_ts_ns": {
                        "type": "int64",
                        "derivation": "window_end_ts_ns - 1e9"
                    },
                    "window_end_ts_ns": {
                        "type": "int64",
                        "unit": "nanoseconds since Unix epoch"
                    },
                    "strike_price_int": {
                        "type": "int64",
                        "unit": "price * 1e9 (bucketed to $1)",
                        "derivation": "round((strike - spot) / $1) * $1 + spot"
                    },
                    "strike_points": {
                        "type": "double",
                        "unit": "dollars",
                        "derivation": "spot_ref + (rel_ticks / 2) * STRIKE_STEP_POINTS"
                    },
                    "right": {
                        "type": "string",
                        "values": ["C", "P"]
                    },
                    "side": {
                        "type": "string",
                        "values": ["A", "B"],
                        "note": "A=ask, B=bid"
                    },
                    "spot_ref_price_int": {
                        "type": "int64",
                        "unit": "price * 1e9",
                        "derivation": "Joined from silver.equity_mbo.book_snapshot_1s"
                    },
                    "rel_ticks": {
                        "type": "int32",
                        "derivation": "round((strike - spot) / STRIKE_STEP_POINTS) * 2",
                        "range": "[-50, 50]",
                        "note": "Always even values (multiples of 2) due to $1 strike grid on $0.50 tick base"
                    },
                    "depth_qty_start": {
                        "type": "double",
                        "unit": "contracts",
                        "derivation": "depth_qty_end - add_qty + pull_qty + fill_qty (clamped >= 0)",
                        "constraint": ">= 0"
                    },
                    "depth_qty_end": {
                        "type": "double",
                        "unit": "contracts",
                        "derivation": "sum(state.bid_size or state.ask_size) per strike bucket at window_end"
                    },
                    "add_qty": {
                        "type": "double",
                        "unit": "contracts",
                        "derivation": "sum(size increases) when BBO price unchanged or new price appears"
                    },
                    "pull_qty": {
                        "type": "double",
                        "unit": "contracts",
                        "derivation": "sum(old_size) when BBO price changes or size decreases"
                    },
                    "pull_qty_rest": {
                        "type": "double",
                        "value": "0.0",
                        "note": "Always 0 - CMBP-1 has no order age information"
                    },
                    "fill_qty": {
                        "type": "double",
                        "value": "0.0",
                        "note": "Always 0 - CMBP-1 has no trade/fill information"
                    },
                    "window_valid": {
                        "type": "boolean",
                        "derivation": "spot_ref_price_int > 0"
                    }
                }
            }
        },
        "gold": {
            "GoldComputeEquityOptionPhysicsSurface1s": {
                "_inputs": ["silver.equity_option_cmbp_1.depth_and_flow_1s"],
                "_contract": "backend/src/data_eng/contracts/gold/equity_option_cmbp_1/physics_surface_1s.avsc",
                "physics_surface_1s": {
                    "add_intensity": {
                        "type": "double",
                        "derivation": "add_qty / (depth_qty_start + 1.0)"
                    },
                    "fill_intensity": {
                        "type": "double",
                        "derivation": "fill_qty / (depth_qty_start + 1.0)"
                    },
                    "pull_intensity": {
                        "type": "double",
                        "derivation": "pull_qty / (depth_qty_start + 1.0)"
                    },
                    "liquidity_velocity": {
                        "type": "double",
                        "derivation": "add_intensity - pull_intensity - fill_intensity"
                    }
                }
            }
        }
    }
}
