{
    "equity_mbo": {
        "bronze": {
            "BronzeIngestEquityMbo": {
                "ts_event": {
                    "built_from": [
                        "raw.market_by_order_dbn.ts_event"
                    ],
                    "transformation_steps": [
                        "Cast to int64",
                        "Output filtered to session window (09:30-09:40 ET for dev)"
                    ]
                },
                "price": {
                    "built_from": [
                        "raw.market_by_order_dbn.price"
                    ],
                    "transformation_steps": [
                        "Cast to int64",
                        "Handle NULL_PRICE (replace with 0 if action is Add/Modify)"
                    ]
                },
                "size": {
                    "built_from": [
                        "raw.market_by_order_dbn.size"
                    ],
                    "transformation_steps": [
                        "Cast to int64"
                    ]
                },
                "action": {
                    "built_from": [
                        "raw.market_by_order_dbn.action"
                    ],
                    "transformation_steps": [
                        "Pass through"
                    ]
                },
                "side": {
                    "built_from": [
                        "raw.market_by_order_dbn.side"
                    ],
                    "transformation_steps": [
                        "Pass through"
                    ]
                },
                "order_id": {
                    "built_from": [
                        "raw.market_by_order_dbn.order_id"
                    ],
                    "transformation_steps": [
                        "Cast to int64"
                    ]
                },
                "flags": {
                    "built_from": [
                        "raw.market_by_order_dbn.flags"
                    ],
                    "transformation_steps": [
                        "Cast to int64"
                    ]
                },
                "instrument_id": {
                    "built_from": [
                        "raw.market_by_order_dbn.instrument_id"
                    ],
                    "transformation_steps": [
                        "Cast to int64"
                    ]
                }
            }
        },
        "silver": {
            "SilverComputeEquityBookStates1s": {
                "book_snapshot_1s": {
                    "window_start_ts_ns": {
                        "built_from": [
                            "bronze.equity_mbo.mbo.ts_event"
                        ],
                        "transformation_steps": [
                            "Floor ts_event to 1s bucket (start of window)"
                        ]
                    },
                    "window_end_ts_ns": {
                        "built_from": [
                            "bronze.equity_mbo.mbo.ts_event"
                        ],
                        "transformation_steps": [
                            "Ceil ts_event to 1s bucket (end of window)"
                        ]
                    },
                    "best_bid_price_int": {
                        "built_from": [
                            "bronze.equity_mbo.mbo.price",
                            "bronze.equity_mbo.mbo.side",
                            "bronze.equity_mbo.mbo.action"
                        ],
                        "transformation_steps": [
                            "Apply stateful updates (Add/Modify/Cancel/Fill) to internal order map",
                            "Aggregate resting quantity by price level",
                            "Select maximum price with quantity > 0 where side='B' at window_end_ts"
                        ]
                    },
                    "best_bid_qty": {
                        "built_from": [
                            "bronze.equity_mbo.mbo.size",
                            "bronze.equity_mbo.mbo.side",
                            "bronze.equity_mbo.mbo.action"
                        ],
                        "transformation_steps": [
                            "Apply stateful updates to internal order map",
                            "Sum quantity of all active orders at Best Bid Price at window_end_ts"
                        ]
                    },
                    "best_ask_price_int": {
                        "built_from": [
                            "bronze.equity_mbo.mbo.price",
                            "bronze.equity_mbo.mbo.side",
                            "bronze.equity_mbo.mbo.action"
                        ],
                        "transformation_steps": [
                            "Apply stateful updates to internal order map",
                            "Aggregate resting quantity by price level",
                            "Select minimum price with quantity > 0 where side='A' at window_end_ts"
                        ]
                    },
                    "best_ask_qty": {
                        "built_from": [
                            "bronze.equity_mbo.mbo.size",
                            "bronze.equity_mbo.mbo.side",
                            "bronze.equity_mbo.mbo.action"
                        ],
                        "transformation_steps": [
                            "Apply stateful updates to internal order map",
                            "Sum quantity of all active orders at Best Ask Price at window_end_ts"
                        ]
                    },
                    "mid_price": {
                        "built_from": [
                            "best_bid_price_int",
                            "best_ask_price_int"
                        ],
                        "transformation_steps": [
                            "Avg(Best Bid, Best Ask) * PRICE_SCALE (1e-9)"
                        ]
                    },
                    "mid_price_int": {
                        "built_from": [
                            "best_bid_price_int",
                            "best_ask_price_int"
                        ],
                        "transformation_steps": [
                            "Round(Avg(Best Bid, Best Ask))"
                        ]
                    },
                    "last_trade_price_int": {
                        "built_from": [
                            "bronze.equity_mbo.mbo.price",
                            "bronze.equity_mbo.mbo.action"
                        ],
                        "transformation_steps": [
                            "Filter action='T'",
                            "Take last observed price in window (or carry forward previous)"
                        ]
                    },
                    "spot_ref_price_int": {
                        "built_from": [
                            "last_trade_price_int"
                        ],
                        "transformation_steps": [
                            "Resolve spot anchor from last trade or BBO at window start",
                            "Round to $0.50 bucket for downstream option alignment"
                        ]
                    },
                    "book_valid": {
                        "built_from": [
                            "internal_state"
                        ],
                        "transformation_steps": [
                            "True if book state is initialized and no Snapshot/Clear flags persisted unexpectedly"
                        ]
                    }
                },
                "depth_and_flow_1s": {
                    "_description": "Bucketed Market Depth and Order Flow for equity MBO.",
                    "_shape": "Long Format (Panel Data)",
                    "_grain": "1 Second x $0.50 Price Bucket",
                    "_primary_key": [
                        "window_end_ts_ns",
                        "price_int"
                    ],
                    "price_int": {
                        "built_from": [
                            "bronze.equity_mbo.mbo.price"
                        ],
                        "transformation_steps": [
                            "Aggregate distinct prices into $0.50 buckets within +/- $50 of spot"
                        ]
                    },
                    "side": {
                        "built_from": [
                            "bronze.equity_mbo.mbo.side"
                        ],
                        "transformation_steps": [
                            "Pass through ('A' or 'B')"
                        ]
                    },
                    "spot_ref_price_int": {
                        "built_from": [
                            "last_trade_price (internal state)"
                        ],
                        "transformation_steps": [
                            "Spot anchor bucketed to $0.50 at window start"
                        ]
                    },
                    "rel_ticks": {
                        "built_from": [
                            "price_int",
                            "spot_ref_price_int"
                        ],
                        "transformation_steps": [
                            "(price_int - spot_ref_price_int) / BUCKET_INT (0.50)",
                            "Round to integer"
                        ],
                        "note": "Spot-anchored coordinate in $0.50 buckets"
                    },
                    "rel_ticks_side": {
                        "built_from": [
                            "price_int",
                            "side",
                            "best_bid_price_int (window start)",
                            "best_ask_price_int (window start)"
                        ],
                        "transformation_steps": [
                            "Bucket best_bid/best_ask to $0.50 grid at window start",
                            "If side='B': (price_int - best_bid_bucket) / BUCKET_INT",
                            "If side='A': (price_int - best_ask_bucket) / BUCKET_INT"
                        ],
                        "note": "Side-anchored coordinate in $0.50 buckets"
                    },
                    "depth_qty_start": {
                        "built_from": [
                            "book_state"
                        ],
                        "transformation_steps": [
                            "calculated as: depth_qty_end - add_qty + pull_qty_total + fill_qty"
                        ]
                    },
                    "depth_qty_end": {
                        "built_from": [
                            "bronze.equity_mbo.mbo"
                        ],
                        "transformation_steps": [
                            "Quantity remaining at bucket at end of window"
                        ]
                    },
                    "add_qty": {
                        "built_from": [
                            "bronze.equity_mbo.mbo.action=A"
                        ],
                        "transformation_steps": [
                            "Sum of added volume in bucket in window"
                        ]
                    },
                    "pull_qty_total": {
                        "built_from": [
                            "bronze.equity_mbo.mbo.action=C|M"
                        ],
                        "transformation_steps": [
                            "Sum of cancelled/reduced volume in bucket in window"
                        ]
                    },
                    "depth_qty_rest": {
                        "built_from": [
                            "bronze.equity_mbo.mbo"
                        ],
                        "transformation_steps": [
                            "Quantity of orders resting for > 500ms, aggregated to bucket"
                        ]
                    },
                    "pull_qty_rest": {
                        "built_from": [
                            "bronze.equity_mbo.mbo"
                        ],
                        "transformation_steps": [
                            "Sum of cancelled volume from orders resting > 500ms, aggregated to bucket"
                        ]
                    },
                    "fill_qty": {
                        "built_from": [
                            "bronze.equity_mbo.mbo.action=F"
                        ],
                        "transformation_steps": [
                            "Sum of filled volume in bucket in window"
                        ]
                    }
                }
            }
        },
        "gold": {
            "GoldComputeEquityPhysicsSurface1s": {
                "_inputs": [
                    "silver.equity_mbo.book_snapshot_1s",
                    "silver.equity_mbo.depth_and_flow_1s"
                ],
                "physics_surface_1s": {
                    "rel_ticks_side": {
                        "built_from": [
                            "silver.equity_mbo.depth_and_flow_1s.rel_ticks_side"
                        ],
                        "transformation_steps": [
                            "Pass through"
                        ]
                    },
                    "add_intensity": {
                        "built_from": [
                            "silver.equity_mbo.depth_and_flow_1s.add_qty",
                            "silver.equity_mbo.depth_and_flow_1s.depth_qty_start"
                        ],
                        "transformation_steps": [
                            "add_qty / (depth_qty_start + 1.0)"
                        ]
                    },
                    "fill_intensity": {
                        "built_from": [
                            "silver.equity_mbo.depth_and_flow_1s.fill_qty",
                            "silver.equity_mbo.depth_and_flow_1s.depth_qty_start"
                        ],
                        "transformation_steps": [
                            "fill_qty / (depth_qty_start + 1.0)"
                        ]
                    },
                    "pull_intensity": {
                        "built_from": [
                            "silver.equity_mbo.depth_and_flow_1s.pull_qty_total",
                            "silver.equity_mbo.depth_and_flow_1s.depth_qty_start"
                        ],
                        "transformation_steps": [
                            "pull_qty_total / (depth_qty_start + 1.0)"
                        ]
                    },
                    "liquidity_velocity": {
                        "built_from": [
                            "add_intensity",
                            "pull_intensity",
                            "fill_intensity"
                        ],
                        "transformation_steps": [
                            "add_intensity - pull_intensity - fill_intensity"
                        ],
                        "note": "True net change in liquidity in $0.50 buckets"
                    }
                }
            }
        }
    },
    "equity_option_mbo": {
        "bronze": {
            "BronzeIngestEquityOptionMbo": {
                "ts_event": {
                    "built_from": [
                        "raw.cmbp_1.ts_event"
                    ],
                    "transformation_steps": [
                        "Cast to int64",
                        "Output filtered to session window (09:30-09:40 ET for dev)"
                    ]
                },
                "bid_px_00": {
                    "built_from": [
                        "raw.cmbp_1.bid_px_00"
                    ],
                    "transformation_steps": [
                        "Cast to int64",
                        "Handle NULL_PRICE (replace with 0)"
                    ]
                },
                "ask_px_00": {
                    "built_from": [
                        "raw.cmbp_1.ask_px_00"
                    ],
                    "transformation_steps": [
                        "Cast to int64",
                        "Handle NULL_PRICE (replace with 0)"
                    ]
                },
                "bid_sz_00": {
                    "built_from": [
                        "raw.cmbp_1.bid_sz_00"
                    ],
                    "transformation_steps": [
                        "Cast to int64"
                    ]
                },
                "ask_sz_00": {
                    "built_from": [
                        "raw.cmbp_1.ask_sz_00"
                    ],
                    "transformation_steps": [
                        "Cast to int64"
                    ]
                },
                "instrument_id": {
                    "built_from": [
                        "raw.cmbp_1.instrument_id"
                    ],
                    "transformation_steps": [
                        "Cast to int64"
                    ]
                },
                "underlying": {
                    "built_from": [
                        "definitions.underlying"
                    ],
                    "transformation_steps": [
                        "Join OPRA definitions on instrument_id",
                        "Filter to underlying symbol and 0DTE expiration"
                    ]
                },
                "right": {
                    "built_from": [
                        "definitions.instrument_class"
                    ],
                    "transformation_steps": [
                        "Map to right ('C' or 'P') from OPRA definitions"
                    ]
                },
                "strike": {
                    "built_from": [
                        "definitions.strike_price"
                    ],
                    "transformation_steps": [
                        "Cast to int64"
                    ]
                },
                "expiration": {
                    "built_from": [
                        "definitions.expiration"
                    ],
                    "transformation_steps": [
                        "Cast to int64"
                    ]
                }
            }
        },
        "silver": {
            "SilverComputeEquityOptionBookStates1s": {
                "book_snapshot_1s": {
                    "window_start_ts_ns": {
                        "built_from": [
                            "bronze.equity_option_mbo.cmbp_1.ts_event"
                        ],
                        "transformation_steps": [
                            "Floor ts_event to 1s bucket (start of window)"
                        ]
                    },
                    "window_end_ts_ns": {
                        "built_from": [
                            "bronze.equity_option_mbo.cmbp_1.ts_event"
                        ],
                        "transformation_steps": [
                            "Ceil ts_event to 1s bucket (end of window)"
                        ]
                    },
                    "bid_price_int": {
                        "built_from": [
                            "bronze.equity_option_mbo.cmbp_1.bid_px_00"
                        ],
                        "transformation_steps": [
                            "Use CMBP-1 bid price per instrument at window_end_ts"
                        ]
                    },
                    "ask_price_int": {
                        "built_from": [
                            "bronze.equity_option_mbo.cmbp_1.ask_px_00"
                        ],
                        "transformation_steps": [
                            "Use CMBP-1 ask price per instrument at window_end_ts"
                        ]
                    },
                    "mid_price_int": {
                        "built_from": [
                            "bid_price_int",
                            "ask_price_int"
                        ],
                        "transformation_steps": [
                            "Avg(Best Bid, Best Ask)"
                        ]
                    },
                    "mid_price": {
                        "built_from": [
                            "mid_price_int"
                        ],
                        "transformation_steps": [
                            "mid_price_int * PRICE_SCALE (1e-9)"
                        ]
                    },
                    "spot_ref_price_int": {
                        "built_from": [
                            "silver.equity_mbo.book_snapshot_1s.spot_ref_price_int"
                        ],
                        "transformation_steps": [
                            "Spot anchor from equity MBO snapshot at window_end_ts"
                        ]
                    },
                    "book_valid": {
                        "built_from": [
                            "internal_state"
                        ],
                        "transformation_steps": [
                            "True if bid/ask available per instrument"
                        ]
                    }
                },
                "depth_and_flow_1s": {
                    "_description": "Equity option depth/flow from CMBP-1, bucketed to $1 strikes.",
                    "_shape": "Long Format (Panel Data)",
                    "_grain": "1 Second x Strike Bucket x Right x Side",
                    "_primary_key": [
                        "window_end_ts_ns",
                        "strike_price_int",
                        "right",
                        "side"
                    ],
                    "strike_price_int": {
                        "built_from": [
                            "bronze.equity_option_mbo.cmbp_1.strike"
                        ],
                        "transformation_steps": [
                            "Bucket strikes every $1 and align to spot grid +/- $25"
                        ]
                    },
                    "spot_ref_price_int": {
                        "built_from": [
                            "silver.equity_mbo.book_snapshot_1s.spot_ref_price_int"
                        ],
                        "transformation_steps": [
                            "Spot anchor from equity MBO snapshot at window_end_ts"
                        ]
                    },
                    "rel_ticks": {
                        "built_from": [
                            "strike_price_int",
                            "spot_ref_price_int"
                        ],
                        "transformation_steps": [
                            "(strike_price_int - spot_ref_price_int) / 0.50",
                            "Round to integer (multiples of 2 ticks per $1)"
                        ]
                    },
                    "depth_qty_start": {
                        "built_from": [
                            "CMBP-1 L1 state"
                        ],
                        "transformation_steps": [
                            "calculated as: depth_qty_end - add_qty + pull_qty_total + fill_qty"
                        ]
                    },
                    "depth_qty_end": {
                        "built_from": [
                            "bronze.equity_option_mbo.cmbp_1.bid_sz_00",
                            "bronze.equity_option_mbo.cmbp_1.ask_sz_00"
                        ],
                        "transformation_steps": [
                            "End-of-window L1 size at strike bucket"
                        ]
                    },
                    "add_qty": {
                        "built_from": [
                            "CMBP-1 L1 size deltas"
                        ],
                        "transformation_steps": [
                            "Sum of size increases at strike bucket in window"
                        ]
                    },
                    "pull_qty_total": {
                        "built_from": [
                            "CMBP-1 L1 size deltas"
                        ],
                        "transformation_steps": [
                            "Sum of size decreases or price moves at strike bucket in window"
                        ]
                    },
                    "pull_qty_rest": {
                        "built_from": [
                            "CMBP-1 L1 updates"
                        ],
                        "transformation_steps": [
                            "Set to 0.0 (resting age not observable in CMBP-1)"
                        ]
                    },
                    "fill_qty": {
                        "built_from": [
                            "CMBP-1 L1 updates"
                        ],
                        "transformation_steps": [
                            "Set to 0.0 (fills not observable in CMBP-1)"
                        ]
                    }
                }
            }
        },
        "gold": {
            "GoldComputeEquityOptionPhysicsSurface1s": {
                "_inputs": [
                    "silver.equity_option_mbo.depth_and_flow_1s"
                ],
                "physics_surface_1s": {
                    "add_intensity": {
                        "built_from": [
                            "silver.equity_option_mbo.depth_and_flow_1s.add_qty",
                            "silver.equity_option_mbo.depth_and_flow_1s.depth_qty_start"
                        ],
                        "transformation_steps": [
                            "add_qty / (depth_qty_start + 1.0)"
                        ]
                    },
                    "fill_intensity": {
                        "built_from": [
                            "silver.equity_option_mbo.depth_and_flow_1s.fill_qty",
                            "silver.equity_option_mbo.depth_and_flow_1s.depth_qty_start"
                        ],
                        "transformation_steps": [
                            "fill_qty / (depth_qty_start + 1.0)"
                        ]
                    },
                    "pull_intensity": {
                        "built_from": [
                            "silver.equity_option_mbo.depth_and_flow_1s.pull_qty_total",
                            "silver.equity_option_mbo.depth_and_flow_1s.depth_qty_start"
                        ],
                        "transformation_steps": [
                            "pull_qty_total / (depth_qty_start + 1.0)"
                        ]
                    },
                    "liquidity_velocity": {
                        "built_from": [
                            "add_intensity",
                            "pull_intensity",
                            "fill_intensity"
                        ],
                        "transformation_steps": [
                            "add_intensity - pull_intensity - fill_intensity"
                        ],
                        "note": "True net change in liquidity at the strike bucket"
                    }
                }
            }
        }
    }
}