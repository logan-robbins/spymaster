<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vacuum & Pressure Detector</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #0a0a0f;
      overflow: hidden;
      font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
      color: #ccc;
    }

    #app {
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 100vw;
    }

    /* -- Warning banner -- */
    #warning-banner {
      display: none;
      padding: 6px 16px;
      background: #664400;
      color: #ffcc00;
      font-size: 11px;
      font-weight: 600;
      text-align: center;
      flex-shrink: 0;
    }

    /* -- Top bar -- */
    #top-bar {
      height: 42px;
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 0 16px;
      background: rgba(15, 15, 25, 0.95);
      border-bottom: 1px solid rgba(100, 100, 150, 0.25);
      font-size: 11px;
      flex-shrink: 0;
    }
    #top-bar .title {
      font-size: 12px;
      font-weight: 700;
      color: #00ffaa;
      letter-spacing: 1px;
    }
    #top-bar .sep {
      width: 1px;
      height: 20px;
      background: rgba(100, 100, 150, 0.3);
    }
    #top-bar .info { color: #888; }
    #top-bar .val  { color: #ddd; font-weight: 500; }
    #top-bar .meta-label { color: #666; font-size: 9px; text-transform: uppercase; }
    #top-bar .meta-val   { color: #aaa; font-size: 10px; font-weight: 500; }
    #spot-val  { color: #00ffcc; font-weight: 700; font-size: 13px; }
    #ts-val    { color: #aaa; }

    /* -- Main content -- */
    #main {
      flex: 1;
      display: flex;
      min-height: 0;
    }

    /* Depth profile panel */
    #profile-panel {
      width: 140px;
      flex-shrink: 0;
      position: relative;
      border-right: 1px solid rgba(100, 100, 150, 0.2);
    }
    #profile-canvas {
      width: 100%;
      height: 100%;
      display: block;
    }

    /* Heatmap panel */
    #heatmap-panel {
      flex: 1;
      position: relative;
      min-width: 0;
    }
    #heatmap-canvas {
      width: 100%;
      height: 100%;
      display: block;
      cursor: grab;
      touch-action: none;       /* prevent browser pinch-zoom / scroll */
      user-select: none;        /* prevent text selection during drag */
      -webkit-user-select: none;
    }
    /* Spot line label overlaid on heatmap */
    #spot-line-label {
      position: absolute;
      left: 4px;
      color: rgba(0, 255, 170, 0.6);
      font-size: 9px;
      pointer-events: none;
      z-index: 10;
    }

    /* Price axis */
    #price-axis-panel {
      width: 60px;
      flex-shrink: 0;
      position: relative;
      border-left: 1px solid rgba(100, 100, 150, 0.2);
    }
    #price-axis-canvas {
      width: 100%;
      height: 100%;
      display: block;
    }

    /* Signal panel */
    #signal-panel {
      width: 200px;
      flex-shrink: 0;
      border-left: 1px solid rgba(100, 100, 150, 0.2);
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      overflow-y: auto;
    }
    .sig-section {
      padding: 10px;
      background: rgba(20, 20, 35, 0.6);
      border-radius: 6px;
      border: 1px solid rgba(100, 100, 150, 0.15);
    }
    .sig-title {
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #666;
      margin-bottom: 8px;
      padding-bottom: 4px;
      border-bottom: 1px solid rgba(100, 100, 150, 0.2);
    }
    .sig-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
      font-size: 11px;
    }
    .sig-label { color: #888; }
    .sig-value { font-weight: 600; }

    /* Composite bar */
    #composite-bar {
      height: 20px;
      border-radius: 4px;
      background: linear-gradient(to right, #cc2222, #444, #22cc66);
      position: relative;
      margin-top: 4px;
    }
    #composite-marker {
      position: absolute;
      top: -2px;
      width: 4px;
      height: 24px;
      background: #fff;
      border-radius: 2px;
      transform: translateX(-50%);
      transition: left 0.15s ease;
    }

    /* Derivative gauges */
    .deriv-gauge {
      height: 8px;
      background: rgba(40, 40, 60, 0.8);
      border-radius: 4px;
      position: relative;
      margin-top: 4px;
      overflow: hidden;
    }
    .deriv-fill {
      position: absolute;
      top: 0;
      height: 100%;
      border-radius: 4px;
      transition: left 0.15s, width 0.15s;
    }

    /* -- Bottom bar -- */
    #bottom-bar {
      height: 50px;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 0 16px;
      background: rgba(15, 15, 25, 0.95);
      border-top: 1px solid rgba(100, 100, 150, 0.25);
      font-size: 11px;
      flex-shrink: 0;
    }
    #composite-label {
      font-size: 18px;
      font-weight: 700;
      min-width: 120px;
    }
    .bar-stat { color: #888; }
    .bar-stat .v { color: #ddd; font-weight: 500; }

    /* Legend */
    #legend {
      margin-left: auto;
      display: flex;
      gap: 12px;
      font-size: 10px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 2px;
    }
    .legend-text { color: #888; }
  </style>
</head>
<body>
  <div id="app">
    <!-- Warning banner (hidden by default, shown for legacy fallback or missing params) -->
    <div id="warning-banner">
      LEGACY MODE: No runtime config received from server. Using fallback equity defaults ($0.50 bucket). Update backend.
    </div>

    <!-- Top bar -->
    <div id="top-bar">
      <span class="title">VP DETECTOR</span>
      <div class="sep"></div>
      <span class="info">Spot</span>
      <span id="spot-val">--</span>
      <div class="sep"></div>
      <span class="info">Time</span>
      <span id="ts-val" class="val">--:--:--</span>
      <div class="sep"></div>
      <span class="info">Window</span>
      <span id="win-val" class="val">0</span>
      <div class="sep"></div>
      <!-- Runtime metadata (populated once config arrives from server) -->
      <span class="meta-label">Type</span>
      <span id="meta-product" class="meta-val">--</span>
      <span class="meta-label">Sym</span>
      <span id="meta-symbol" class="meta-val">--</span>
      <span class="meta-label">Tick</span>
      <span id="meta-tick" class="meta-val">--</span>
      <span class="meta-label">Bucket</span>
      <span id="meta-bucket" class="meta-val">--</span>
      <span class="meta-label">Mult</span>
      <span id="meta-mult" class="meta-val">--</span>
    </div>

    <!-- Main content -->
    <div id="main">
      <!-- Depth profile -->
      <div id="profile-panel">
        <canvas id="profile-canvas"></canvas>
      </div>

      <!-- Heatmap -->
      <div id="heatmap-panel">
        <canvas id="heatmap-canvas"></canvas>
        <span id="spot-line-label">SPOT</span>
      </div>

      <!-- Price axis -->
      <div id="price-axis-panel">
        <canvas id="price-axis-canvas"></canvas>
      </div>

      <!-- Signal panel -->
      <div id="signal-panel">
        <!-- Composite -->
        <div class="sig-section">
          <div class="sig-title">Composite Signal</div>
          <div class="sig-row">
            <span class="sig-label">Value</span>
            <span id="sig-composite" class="sig-value">0.0</span>
          </div>
          <div id="composite-bar">
            <div id="composite-marker" style="left: 50%"></div>
          </div>
          <div class="sig-row" style="margin-top: 8px;">
            <span class="sig-label">Confidence</span>
            <span id="sig-confidence" class="sig-value">0%</span>
          </div>
          <div class="sig-row">
            <span class="sig-label">Strength</span>
            <span id="sig-strength" class="sig-value">0%</span>
          </div>
        </div>

        <!-- Derivatives -->
        <div class="sig-section">
          <div class="sig-title">Derivatives</div>
          <div class="sig-row">
            <span class="sig-label">Velocity (d/dt)</span>
            <span id="sig-d1" class="sig-value">0.0</span>
          </div>
          <div class="deriv-gauge"><div id="d1-fill" class="deriv-fill"></div></div>

          <div class="sig-row" style="margin-top: 8px;">
            <span class="sig-label">Accel (d2/dt2)</span>
            <span id="sig-d2" class="sig-value">0.0</span>
          </div>
          <div class="deriv-gauge"><div id="d2-fill" class="deriv-fill"></div></div>

          <div class="sig-row" style="margin-top: 8px;">
            <span class="sig-label">Jerk (d3/dt3)</span>
            <span id="sig-d3" class="sig-value">0.0</span>
          </div>
          <div class="deriv-gauge"><div id="d3-fill" class="deriv-fill"></div></div>
        </div>

        <!-- Components -->
        <div class="sig-section">
          <div class="sig-title">Components</div>
          <div class="sig-row">
            <span class="sig-label">Vac Above</span>
            <span id="sig-vac-above" class="sig-value">0</span>
          </div>
          <div class="sig-row">
            <span class="sig-label">Vac Below</span>
            <span id="sig-vac-below" class="sig-value">0</span>
          </div>
          <div class="sig-row">
            <span class="sig-label">Flow Imbal</span>
            <span id="sig-flow" class="sig-value">0</span>
          </div>
          <div class="sig-row">
            <span class="sig-label">Fill Imbal</span>
            <span id="sig-fill" class="sig-value">0</span>
          </div>
          <div class="sig-row">
            <span class="sig-label">Depth Imbal</span>
            <span id="sig-depth" class="sig-value">0.0</span>
          </div>
          <div class="sig-row">
            <span class="sig-label">Rest Depth</span>
            <span id="sig-rest-depth" class="sig-value">0.0</span>
          </div>
          <div class="sig-row">
            <span class="sig-label">Inst Drain A</span>
            <span id="sig-drain-ask" class="sig-value">0</span>
          </div>
          <div class="sig-row">
            <span class="sig-label">Inst Drain B</span>
            <span id="sig-drain-bid" class="sig-value">0</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Bottom bar -->
    <div id="bottom-bar">
      <span id="composite-label" style="color: #888;">NEUTRAL</span>
      <div class="sep" style="height: 24px;"></div>
      <span class="bar-stat">d/dt <span id="bot-d1" class="v">0</span></span>
      <span class="bar-stat">d2/dt2 <span id="bot-d2" class="v">0</span></span>
      <span class="bar-stat">d3/dt3 <span id="bot-d3" class="v">0</span></span>

      <div id="legend">
        <div class="legend-item">
          <div class="legend-dot" style="background: #22cc66;"></div>
          <span class="legend-text">Pressure (building)</span>
        </div>
        <div class="legend-item">
          <div class="legend-dot" style="background: #cc2255;"></div>
          <span class="legend-text">Vacuum (draining)</span>
        </div>
        <div class="legend-item">
          <div class="legend-dot" style="background: #1a1a2a;"></div>
          <span class="legend-text">Void (empty)</span>
        </div>
      </div>
    </div>
  </div>

  <script type="module" src="/src/vacuum-pressure.ts"></script>
</body>
</html>
