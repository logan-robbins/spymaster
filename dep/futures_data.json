{
    "_metadata": {
        "version": "2026-02-01",
        "description": "Data catalog for futures MBO and futures options MBO product types",
        "validation_status": "PASS",
        "validated_dates": ["2026-01-06", "2026-01-07", "2026-01-08", "2026-01-14", "2026-01-23"],
        "constants": {
            "PRICE_SCALE": 1e-9,
            "TICK_SIZE": 0.25,
            "TICK_INT": 250000000,
            "WINDOW_NS": 1000000000,
            "REST_NS": 500000000,
            "GRID_MAX_TICKS": "product-dependent (see config/products.yaml): ES/MES=200, NQ/MNQ=400",
            "STRIKE_TICKS": "product-dependent: strike_step_points / tick_size (ES/MES/NQ/MNQ=20)"
        }
    },
    "future_mbo": {
        "_description": "CME futures market-by-order data via Databento (ES, MES, NQ, MNQ, GC, SI, CL, 6E)",
        "_symbol_convention": "Bronze uses parent symbol (ES), Silver uses contract symbol (ESH6)",
        "_bronze_window": "00:00-24:00 UTC (full UTC day, captures Databento MBO snapshot at 00:00 UTC with F_SNAPSHOT=32)",
        "_silver_output_window": "09:30-12:30 ET (first 3 hours of RTH)",
        "_warmup_period": "15 hours before output window (reaches back past 00:00 UTC to capture daily MBO snapshot)",
        "bronze": {
            "_table": "mbo",
            "_source": "raw.market_by_order_dbn",
            "_path": "bronze/source=databento/product_type=future_mbo/symbol={symbol}/table=mbo/dt={dt}",
            "_contract": "src/data_eng/contracts/bronze/future_mbo/mbo.avsc",
            "BronzeIngestFutureMbo": {
                "ts_event": {
                    "type": "int64",
                    "unit": "nanoseconds (UTC)",
                    "built_from": ["raw.market_by_order_dbn.ts_event"],
                    "transformation_steps": [
                        "Cast to int64",
                        "Output filtered to session window (09:30-12:30 ET)"
                    ]
                },
                "price": {
                    "type": "int64",
                    "unit": "price * 1e9 (scaled integer)",
                    "built_from": ["raw.market_by_order_dbn.price"],
                    "transformation_steps": [
                        "Cast to int64",
                        "Handle NULL_PRICE (replace with 0 if action is Add/Modify)"
                    ],
                    "note": "E.g., price=6945250000000 represents $6945.25"
                },
                "size": {
                    "type": "int64",
                    "unit": "contracts",
                    "built_from": ["raw.market_by_order_dbn.size"],
                    "transformation_steps": ["Cast to int64"]
                },
                "action": {
                    "type": "string",
                    "values": ["A=Add", "C=Cancel", "M=Modify", "T=Trade", "F=Fill", "R=Clear"],
                    "built_from": ["raw.market_by_order_dbn.action"],
                    "transformation_steps": ["Pass through"]
                },
                "side": {
                    "type": "string",
                    "values": ["A=Ask", "B=Bid", "N=None"],
                    "built_from": ["raw.market_by_order_dbn.side"],
                    "transformation_steps": ["Pass through"]
                },
                "order_id": {
                    "type": "int64",
                    "unit": "unique order identifier",
                    "built_from": ["raw.market_by_order_dbn.order_id"],
                    "transformation_steps": ["Cast to int64"]
                },
                "flags": {
                    "type": "int64",
                    "values": ["128=F_SNAPSHOT (snapshot message)", "256=F_LAST (last snapshot message)"],
                    "built_from": ["raw.market_by_order_dbn.flags"],
                    "transformation_steps": ["Cast to int64"]
                },
                "instrument_id": {
                    "type": "int64",
                    "unit": "Databento instrument identifier",
                    "built_from": ["raw.market_by_order_dbn.instrument_id"],
                    "transformation_steps": ["Cast to int64"]
                }
            }
        },
        "silver": {
            "_description": "Book reconstruction and depth/flow aggregation from MBO events",
            "SilverComputeBookStates1s": {
                "book_snapshot_1s": {
                    "_description": "1-second NBBO snapshots with BBO prices and quantities",
                    "_path": "silver/product_type=future_mbo/symbol={symbol}/table=book_snapshot_1s/dt={dt}",
                    "_contract": "src/data_eng/contracts/silver/future_mbo/book_snapshot_1s.avsc",
                    "_grain": "1 second windows",
                    "_rows_per_day": "~10,801 (3 hours at 1s intervals)",
                    "window_start_ts_ns": {
                        "type": "int64",
                        "unit": "nanoseconds (UTC)",
                        "built_from": ["bronze.future_mbo.mbo.ts_event"],
                        "transformation_steps": ["Floor ts_event to 1s bucket (start of window)"]
                    },
                    "window_end_ts_ns": {
                        "type": "int64",
                        "unit": "nanoseconds (UTC)",
                        "built_from": ["bronze.future_mbo.mbo.ts_event"],
                        "transformation_steps": ["Ceil ts_event to 1s bucket (end of window)"]
                    },
                    "best_bid_price_int": {
                        "type": "int64",
                        "unit": "price * 1e9",
                        "built_from": ["bronze.future_mbo.mbo.price", "bronze.future_mbo.mbo.side", "bronze.future_mbo.mbo.action"],
                        "transformation_steps": [
                            "Apply stateful updates (Add/Modify/Cancel/Fill) to internal order map",
                            "Aggregate resting quantity by price level",
                            "Select maximum price with quantity > 0 where side='B' at window_end_ts"
                        ]
                    },
                    "best_bid_qty": {
                        "type": "int64",
                        "unit": "contracts",
                        "built_from": ["bronze.future_mbo.mbo.size", "bronze.future_mbo.mbo.side", "bronze.future_mbo.mbo.action"],
                        "transformation_steps": [
                            "Apply stateful updates to internal order map",
                            "Sum quantity of all active orders at Best Bid Price at window_end_ts"
                        ]
                    },
                    "best_ask_price_int": {
                        "type": "int64",
                        "unit": "price * 1e9",
                        "built_from": ["bronze.future_mbo.mbo.price", "bronze.future_mbo.mbo.side", "bronze.future_mbo.mbo.action"],
                        "transformation_steps": [
                            "Apply stateful updates to internal order map",
                            "Aggregate resting quantity by price level",
                            "Select minimum price with quantity > 0 where side='A' at window_end_ts"
                        ]
                    },
                    "best_ask_qty": {
                        "type": "int64",
                        "unit": "contracts",
                        "built_from": ["bronze.future_mbo.mbo.size", "bronze.future_mbo.mbo.side", "bronze.future_mbo.mbo.action"],
                        "transformation_steps": [
                            "Apply stateful updates to internal order map",
                            "Sum quantity of all active orders at Best Ask Price at window_end_ts"
                        ]
                    },
                    "mid_price": {
                        "type": "double",
                        "unit": "dollars",
                        "formula": "(best_bid_price_int + best_ask_price_int) / 2 * 1e-9",
                        "built_from": ["best_bid_price_int", "best_ask_price_int"],
                        "transformation_steps": ["Avg(Best Bid, Best Ask) * PRICE_SCALE (1e-9)"]
                    },
                    "mid_price_int": {
                        "type": "int64",
                        "unit": "price * 1e9",
                        "formula": "round((best_bid_price_int + best_ask_price_int) / 2)",
                        "built_from": ["best_bid_price_int", "best_ask_price_int"],
                        "transformation_steps": ["Round(Avg(Best Bid, Best Ask))"]
                    },
                    "last_trade_price_int": {
                        "type": "int64",
                        "unit": "price * 1e9",
                        "built_from": ["bronze.future_mbo.mbo.price", "bronze.future_mbo.mbo.action"],
                        "transformation_steps": [
                            "Filter action='T'",
                            "Take last observed price in window (or carry forward previous)"
                        ]
                    },
                    "spot_ref_price_int": {
                        "type": "int64",
                        "unit": "price * 1e9",
                        "description": "Reference price for anchoring relative tick coordinates",
                        "built_from": ["last_trade_price_int"],
                        "transformation_steps": [
                            "Use last_trade_price_int if present on-book at window start",
                            "If not on-book, fallback to nearest of best_bid_price_int/best_ask_price_int at window start",
                            "If last_trade_price_int is 0, fallback to best_bid_price_int (else best_ask_price_int)"
                        ]
                    },
                    "book_valid": {
                        "type": "boolean",
                        "built_from": ["internal_state"],
                        "transformation_steps": ["True if book state is initialized and no Snapshot/Clear flags persisted unexpectedly"]
                    }
                },
                "depth_and_flow_1s": {
                    "_description": "Granular Market Depth and Order Flow dynamics (Adds/Pulls/Fills) for the Limit Order Book.",
                    "_path": "silver/product_type=future_mbo/symbol={symbol}/table=depth_and_flow_1s/dt={dt}",
                    "_contract": "src/data_eng/contracts/silver/future_mbo/depth_and_flow_1s.avsc",
                    "_shape": "Long Format (Panel Data)",
                    "_grain": "1 Second x Price Level (tick) x Side",
                    "_primary_key": ["window_end_ts_ns", "price_int", "side"],
                    "_rows_per_day": "~3.7-4.3M for ES (401 levels x 2 sides x seconds), scales with GRID_MAX_TICKS",
                    "window_start_ts_ns": {
                        "type": "int64",
                        "unit": "nanoseconds (UTC)"
                    },
                    "window_end_ts_ns": {
                        "type": "int64",
                        "unit": "nanoseconds (UTC)"
                    },
                    "price_int": {
                        "type": "int64",
                        "unit": "price * 1e9",
                        "built_from": ["bronze.future_mbo.mbo.price"],
                        "transformation_steps": ["Aggregate distinct prices in window +/- GRID_MAX_TICKS from spot"]
                    },
                    "side": {
                        "type": "string",
                        "values": ["A=Ask", "B=Bid"],
                        "built_from": ["bronze.future_mbo.mbo.side"],
                        "transformation_steps": ["Pass through ('A' or 'B')"]
                    },
                    "spot_ref_price_int": {
                        "type": "int64",
                        "unit": "price * 1e9",
                        "built_from": ["last_trade_price (internal state)"],
                        "transformation_steps": ["From internal engine state (window-start anchor, same as snapshot)"]
                    },
                    "rel_ticks": {
                        "type": "int32",
                        "unit": "ticks (tick_size each, $0.25 for ES/MES/NQ/MNQ)",
                        "range": "[-GRID_MAX_TICKS, +GRID_MAX_TICKS]",
                        "formula": "round((price_int - spot_ref_price_int) / TICK_INT)",
                        "built_from": ["price_int", "spot_ref_price_int"],
                        "transformation_steps": ["(price_int - spot_ref_price_int) / TICK_INT", "Round to integer"],
                        "note": "Spot-anchored coordinate; keep for spot-based views"
                    },
                    "rel_ticks_side": {
                        "type": "int32",
                        "unit": "ticks ($0.25 each)",
                        "built_from": ["price_int", "side", "best_bid_price_int (window start)", "best_ask_price_int (window start)"],
                        "transformation_steps": [
                            "If side='B': (price_int - best_bid_price_int_start) / TICK_INT",
                            "If side='A': (price_int - best_ask_price_int_start) / TICK_INT",
                            "Round to integer"
                        ],
                        "note": "Primary coordinate for liquidity modeling (side-anchored)"
                    },
                    "depth_qty_start": {
                        "type": "double",
                        "unit": "contracts",
                        "formula": "depth_qty_end - add_qty + pull_qty + fill_qty",
                        "constraint": "depth_qty_start >= 0",
                        "built_from": ["book_state"],
                        "transformation_steps": ["depth_qty_end - add_qty + pull_qty + fill_qty"]
                    },
                    "depth_qty_end": {
                        "type": "double",
                        "unit": "contracts",
                        "constraint": "depth_qty_end >= 0",
                        "built_from": ["bronze.future_mbo.mbo"],
                        "transformation_steps": ["Quantity remaining at price level at end of window"]
                    },
                    "add_qty": {
                        "type": "double",
                        "unit": "contracts",
                        "constraint": "add_qty >= 0",
                        "built_from": ["bronze.future_mbo.mbo.action=A"],
                        "transformation_steps": ["Sum of added volume at price level in window"]
                    },
                    "pull_qty": {
                        "type": "double",
                        "unit": "contracts",
                        "constraint": "pull_qty >= 0",
                        "built_from": ["bronze.future_mbo.mbo.action=C|M"],
                        "transformation_steps": ["Sum of cancelled/reduced volume at price level in window"]
                    },
                    "depth_qty_rest": {
                        "type": "double",
                        "unit": "contracts",
                        "constraint": "depth_qty_rest <= depth_qty_end",
                        "built_from": ["bronze.future_mbo.mbo"],
                        "transformation_steps": ["Quantity of orders resting for > 500ms"]
                    },
                    "pull_qty_rest": {
                        "type": "double",
                        "unit": "contracts",
                        "constraint": "pull_qty_rest <= pull_qty",
                        "built_from": ["bronze.future_mbo.mbo"],
                        "transformation_steps": ["Sum of cancelled volume from orders resting > 500ms"]
                    },
                    "fill_qty": {
                        "type": "double",
                        "unit": "contracts",
                        "constraint": "fill_qty >= 0",
                        "built_from": ["bronze.future_mbo.mbo.action=F"],
                        "transformation_steps": ["Sum of filled volume at price level in window"]
                    },
                    "window_valid": {
                        "type": "boolean",
                        "description": "True if window is valid for downstream analysis (not during snapshot)"
                    }
                }
            }
        },
        "gold": {
            "GoldComputePhysicsSurface1s": {
                "_inputs": ["silver.future_mbo.book_snapshot_1s", "silver.future_mbo.depth_and_flow_1s"],
                "_output_shape": "Dense grid: (2*GRID_MAX_TICKS+1) ticks x 2 sides x N windows (ES=401, MNQ=801)",
                "physics_surface_1s": {
                    "add_intensity": {
                        "built_from": ["silver.future_mbo.depth_and_flow_1s.add_qty", "silver.future_mbo.depth_and_flow_1s.depth_qty_start"],
                        "transformation_steps": ["add_qty / (depth_qty_start + 1.0)"]
                    },
                    "fill_intensity": {
                        "built_from": ["silver.future_mbo.depth_and_flow_1s.fill_qty", "silver.future_mbo.depth_and_flow_1s.depth_qty_start"],
                        "transformation_steps": ["fill_qty / (depth_qty_start + 1.0)"]
                    },
                    "pull_intensity": {
                        "built_from": ["silver.future_mbo.depth_and_flow_1s.pull_qty", "silver.future_mbo.depth_and_flow_1s.depth_qty_start"],
                        "transformation_steps": ["pull_qty / (depth_qty_start + 1.0)"]
                    },
                    "liquidity_velocity": {
                        "built_from": ["add_intensity", "pull_intensity", "fill_intensity"],
                        "transformation_steps": ["add_intensity - pull_intensity - fill_intensity"],
                        "note": "Net change in liquidity. Positive = building, Negative = eroding"
                    },
                    "rho": {
                        "built_from": ["silver.future_mbo.depth_and_flow_1s.depth_qty_end"],
                        "transformation_steps": ["log(1 + depth_qty_end)"],
                        "note": "Log-density of liquidity at price level"
                    },
                    "phi_rest": {
                        "built_from": ["silver.future_mbo.depth_and_flow_1s.depth_qty_rest", "silver.future_mbo.depth_and_flow_1s.depth_qty_end"],
                        "transformation_steps": ["depth_qty_rest / (depth_qty_end + 1.0)"],
                        "note": "Persistence fraction: ratio of rested liquidity to total"
                    },
                    "u_ema_2": {
                        "built_from": ["liquidity_velocity"],
                        "transformation_steps": [
                            "Sort by (rel_ticks, side, window_end_ts_ns)",
                            "GroupBy (rel_ticks, side)",
                            "EWM(alpha=1-exp(-1/2), adjust=False)"
                        ],
                        "note": "Fastest EMA (2s decay)"
                    },
                    "u_ema_8": {
                        "built_from": ["liquidity_velocity"],
                        "transformation_steps": ["GroupBy (rel_ticks, side)", "EWM(alpha=1-exp(-1/8), adjust=False)"],
                        "note": "Mid-scale EMA (8s decay)"
                    },
                    "u_ema_32": {
                        "built_from": ["liquidity_velocity"],
                        "transformation_steps": ["GroupBy (rel_ticks, side)", "EWM(alpha=1-exp(-1/32), adjust=False)"],
                        "note": "Slow EMA (32s decay)"
                    },
                    "u_ema_128": {
                        "built_from": ["liquidity_velocity"],
                        "transformation_steps": ["GroupBy (rel_ticks, side)", "EWM(alpha=1-exp(-1/128), adjust=False)"],
                        "note": "Slowest EMA (128s decay)"
                    },
                    "u_band_fast": {
                        "built_from": ["u_ema_2", "u_ema_8"],
                        "transformation_steps": ["u_ema_2 - u_ema_8"]
                    },
                    "u_band_mid": {
                        "built_from": ["u_ema_8", "u_ema_32"],
                        "transformation_steps": ["u_ema_8 - u_ema_32"]
                    },
                    "u_band_slow": {
                        "built_from": ["u_ema_32", "u_ema_128"],
                        "transformation_steps": ["u_ema_32 - u_ema_128"]
                    },
                    "u_wave_energy": {
                        "built_from": ["u_band_fast", "u_band_mid", "u_band_slow"],
                        "transformation_steps": ["sqrt(u_band_fast^2 + u_band_mid^2 + u_band_slow^2)"],
                        "note": "Total wave energy across time scales"
                    },
                    "du_dt": {
                        "built_from": ["u_ema_2"],
                        "transformation_steps": ["GroupBy (rel_ticks, side)", "diff(u_ema_2) with dt=1s"],
                        "note": "First temporal derivative"
                    },
                    "d2u_dt2": {
                        "built_from": ["du_dt"],
                        "transformation_steps": ["GroupBy (rel_ticks, side)", "diff(du_dt) with dt=1s"],
                        "note": "Second temporal derivative"
                    },
                    "u_p": {
                        "built_from": ["phi_rest", "u_ema_8"],
                        "transformation_steps": ["phi_rest * u_ema_8"],
                        "note": "Persistence-weighted velocity (mid-scale)"
                    },
                    "u_p_slow": {
                        "built_from": ["phi_rest", "u_ema_32"],
                        "transformation_steps": ["phi_rest * u_ema_32"],
                        "note": "Persistence-weighted velocity (slow-scale)"
                    },
                    "Omega": {
                        "built_from": ["rho", "phi_rest", "u_p_slow"],
                        "transformation_steps": ["rho * (0.5 + 0.5*phi_rest) * (1 + max(0, u_p_slow))"],
                        "note": "Raw obstacle strength before spatial smoothing"
                    },
                    "u_near": {
                        "built_from": ["u_ema_8"],
                        "transformation_steps": [
                            "Pivot to [window_end_ts_ns, side] x [rel_ticks -GRID_MAX_TICKS..+GRID_MAX_TICKS]",
                            "Gaussian convolution (scipy, win=33, sigma=6, center=True, axis=rel_ticks)",
                            "Melt back to long format"
                        ],
                        "note": "Near-field spatial smoothing (sigma=6, window=16 ticks each side)"
                    },
                    "u_far": {
                        "built_from": ["u_ema_32"],
                        "transformation_steps": ["Gaussian convolution (scipy, win=129, sigma=24, center=True, axis=rel_ticks)"],
                        "note": "Far-field spatial smoothing (sigma=24, window=64 ticks each side)"
                    },
                    "u_prom": {
                        "built_from": ["u_near", "u_far"],
                        "transformation_steps": ["u_near - u_far"],
                        "note": "Prominence: local strength relative to neighborhood"
                    },
                    "Omega_near": {
                        "built_from": ["Omega"],
                        "transformation_steps": ["Gaussian convolution (scipy, win=33, sigma=6, center=True, axis=rel_ticks)"]
                    },
                    "Omega_far": {
                        "built_from": ["Omega"],
                        "transformation_steps": ["Gaussian convolution (scipy, win=129, sigma=24, center=True, axis=rel_ticks)"]
                    },
                    "Omega_prom": {
                        "built_from": ["Omega_near", "Omega_far"],
                        "transformation_steps": ["Omega_near - Omega_far"],
                        "note": "Obstacle prominence"
                    },
                    "du_dx": {
                        "built_from": ["u_near"],
                        "transformation_steps": ["GroupBy (window_end_ts_ns, side)", "(shift(-1) - shift(1)) * 0.5"],
                        "note": "Central difference spatial derivative"
                    },
                    "d2u_dx2": {
                        "built_from": ["u_near"],
                        "transformation_steps": ["GroupBy (window_end_ts_ns, side)", "shift(-1) - 2*u_near + shift(1)"],
                        "note": "Second spatial derivative (curvature)"
                    },
                    "nu": {
                        "built_from": ["Omega_near", "Omega_prom"],
                        "transformation_steps": ["1 + Omega_near + 2*max(0, Omega_prom)"],
                        "note": "Effective viscosity/resistance"
                    },
                    "kappa": {
                        "built_from": ["nu"],
                        "transformation_steps": ["1 / nu"],
                        "note": "Permeability (inverse of viscosity)"
                    },
                    "pressure_grad": {
                        "built_from": ["u_p", "side"],
                        "transformation_steps": ["If side='B': +u_p, If side='A': -u_p"],
                        "note": "Directional pressure gradient. Positive = upward force, Negative = downward force"
                    }
                }
            }
        }
    },
    "future_option_mbo": {
        "bronze": {
            "BronzeIngestFutureOptionMbo": {
                "ts_event": {
                    "built_from": ["raw.market_by_order_dbn.ts_event"],
                    "transformation_steps": ["Cast to int64", "Output filtered to session window (09:30-09:40 ET for dev)"]
                },
                "price": {
                    "built_from": ["raw.market_by_order_dbn.price"],
                    "transformation_steps": ["Cast to int64", "Handle NULL_PRICE (replace with 0 if action is Add/Modify)"]
                },
                "size": {
                    "built_from": ["raw.market_by_order_dbn.size"],
                    "transformation_steps": ["Cast to int64"]
                },
                "action": {
                    "built_from": ["raw.market_by_order_dbn.action"],
                    "transformation_steps": ["Pass through"]
                },
                "side": {
                    "built_from": ["raw.market_by_order_dbn.side"],
                    "transformation_steps": ["Pass through"]
                },
                "order_id": {
                    "built_from": ["raw.market_by_order_dbn.order_id"],
                    "transformation_steps": ["Cast to int64"]
                },
                "flags": {
                    "built_from": ["raw.market_by_order_dbn.flags"],
                    "transformation_steps": ["Cast to int64"]
                },
                "instrument_id": {
                    "built_from": ["raw.market_by_order_dbn.instrument_id"],
                    "transformation_steps": ["Cast to int64"]
                },
                "strike": {
                    "built_from": ["raw.market_by_order_dbn.strike"],
                    "transformation_steps": ["Cast to int64"]
                },
                "right": {
                    "built_from": ["raw.market_by_order_dbn.instrument_class"],
                    "transformation_steps": ["Map to right ('C' or 'P') from instrument definitions"]
                },
                "expiration": {
                    "built_from": ["raw.market_by_order_dbn.expiration"],
                    "transformation_steps": ["Cast to int64"]
                }
            }
        },
        "silver": {
            "SilverComputeOptionBookStates1s": {
                "book_snapshot_1s": {
                    "_path": "silver/product_type=future_option_mbo/symbol={symbol}/table=book_snapshot_1s/dt={dt}",
                    "_contract": "src/data_eng/contracts/silver/future_option_mbo/book_snapshot_1s.avsc",
                    "_grain": "1 second x instrument",
                    "window_start_ts_ns": {
                        "type": "int64",
                        "unit": "nanoseconds (UTC)",
                        "built_from": ["bronze.future_option_mbo.mbo.ts_event"],
                        "transformation_steps": ["Floor ts_event to 1s bucket (start of window)"]
                    },
                    "window_end_ts_ns": {
                        "type": "int64",
                        "unit": "nanoseconds (UTC)",
                        "built_from": ["bronze.future_option_mbo.mbo.ts_event"],
                        "transformation_steps": ["Ceil ts_event to 1s bucket (end of window)"]
                    },
                    "instrument_id": {
                        "type": "int64",
                        "unit": "Databento instrument identifier",
                        "built_from": ["bronze.future_option_mbo.mbo.instrument_id"],
                        "transformation_steps": ["Pass through"]
                    },
                    "right": {
                        "type": "string",
                        "values": ["C=Call", "P=Put"],
                        "built_from": ["bronze.future_option_mbo.mbo.right"],
                        "transformation_steps": ["Pass through"]
                    },
                    "strike_price_int": {
                        "type": "int64",
                        "unit": "price * 1e9",
                        "built_from": ["bronze.future_option_mbo.mbo.strike"],
                        "transformation_steps": ["Pass through"]
                    },
                    "bid_price_int": {
                        "built_from": ["bronze.future_option_mbo.mbo.price", "bronze.future_option_mbo.mbo.side", "bronze.future_option_mbo.mbo.action"],
                        "transformation_steps": ["Stateful order map per instrument", "Select maximum price with quantity > 0 where side='B' at window_end_ts"]
                    },
                    "ask_price_int": {
                        "built_from": ["bronze.future_option_mbo.mbo.price", "bronze.future_option_mbo.mbo.side", "bronze.future_option_mbo.mbo.action"],
                        "transformation_steps": ["Stateful order map per instrument", "Select minimum price with quantity > 0 where side='A' at window_end_ts"]
                    },
                    "mid_price_int": {
                        "built_from": ["bid_price_int", "ask_price_int"],
                        "transformation_steps": ["Round(Avg(Best Bid, Best Ask))"]
                    },
                    "mid_price": {
                        "built_from": ["mid_price_int"],
                        "transformation_steps": ["mid_price_int * PRICE_SCALE (1e-9)"]
                    },
                    "spot_ref_price_int": {
                        "built_from": ["silver.future_mbo.book_snapshot_1s.spot_ref_price_int"],
                        "transformation_steps": ["Spot anchor from futures MBO snapshot at window_end_ts"]
                    },
                    "book_valid": {
                        "built_from": ["internal_state"],
                        "transformation_steps": ["True if book state is initialized per instrument"]
                    }
                },
                "depth_and_flow_1s": {
                    "_description": "Option MBO depth and flow aggregated to strike_step_points strike buckets, spot-anchored.",
                    "_path": "silver/product_type=future_option_mbo/symbol={symbol}/table=depth_and_flow_1s/dt={dt}",
                    "_contract": "src/data_eng/contracts/silver/future_option_mbo/depth_and_flow_1s.avsc",
                    "_shape": "Long Format (Panel Data)",
                    "_grain": "1 Second x Strike Bucket x Right x Side",
                    "_primary_key": ["window_end_ts_ns", "strike_price_int", "right", "side"],
                    "_note_strike_bucketing": "Flow quantities are SUMMED across individual instruments per strike_step_points bucket (from products.yaml). This aggregation can cause depth_qty_start accounting identity to have ~8-10% mismatch due to instruments moving between buckets.",
                    "_note_validated": "Validated 2026-01-07, 2026-01-14, 2026-01-23: 0 null values, 0 negative quantities, 100% 1-second windows, spot prices $6900-$7100",
                    "window_start_ts_ns": {
                        "type": "int64",
                        "unit": "nanoseconds (UTC)",
                        "built_from": ["bronze.future_option_mbo.mbo.ts_event"],
                        "transformation_steps": ["Floor ts_event to 1s bucket (start of window)"]
                    },
                    "window_end_ts_ns": {
                        "type": "int64",
                        "unit": "nanoseconds (UTC)",
                        "built_from": ["bronze.future_option_mbo.mbo.ts_event"],
                        "transformation_steps": ["Ceil ts_event to 1s bucket (end of window)"]
                    },
                    "strike_price_int": {
                        "type": "int64",
                        "unit": "price * 1e9",
                        "built_from": ["bronze.future_option_mbo.mbo.strike"],
                        "transformation_steps": ["Bucket strikes every strike_step_points and align to spot grid"]
                    },
                    "strike_points": {
                        "type": "double",
                        "unit": "dollars",
                        "built_from": ["strike_price_int"],
                        "transformation_steps": ["strike_price_int * PRICE_SCALE"]
                    },
                    "right": {
                        "type": "string",
                        "values": ["C=Call", "P=Put"],
                        "built_from": ["bronze.future_option_mbo.mbo.right"],
                        "transformation_steps": ["Pass through"]
                    },
                    "side": {
                        "type": "string",
                        "values": ["A=Ask", "B=Bid"],
                        "built_from": ["bronze.future_option_mbo.mbo.side"],
                        "transformation_steps": ["Pass through"]
                    },
                    "spot_ref_price_int": {
                        "type": "int64",
                        "unit": "price * 1e9",
                        "built_from": ["silver.future_mbo.book_snapshot_1s.spot_ref_price_int"],
                        "transformation_steps": ["Spot anchor from futures MBO snapshot at window_end_ts"]
                    },
                    "rel_ticks": {
                        "type": "int32",
                        "unit": "ticks",
                        "built_from": ["strike_price_int", "spot_ref_price_int"],
                        "transformation_steps": ["(strike_price_int - spot_ref_price_int) / TICK_INT", "Round to integer (multiples of STRIKE_TICKS)"]
                    },
                    "depth_qty_start": {
                        "type": "double",
                        "unit": "contracts",
                        "built_from": ["book_state"],
                        "transformation_steps": ["depth_qty_end - add_qty + pull_qty + fill_qty"]
                    },
                    "depth_qty_end": {
                        "type": "double",
                        "unit": "contracts",
                        "built_from": ["bronze.future_option_mbo.mbo"],
                        "transformation_steps": ["Quantity remaining at strike bucket at end of window"],
                        "note": "AUTHORITATIVE value when accounting_identity_valid=False"
                    },
                    "add_qty": {
                        "type": "double",
                        "unit": "contracts",
                        "built_from": ["bronze.future_option_mbo.mbo.action=A"],
                        "transformation_steps": ["Sum of added volume at strike bucket in window"]
                    },
                    "pull_qty": {
                        "type": "double",
                        "unit": "contracts",
                        "built_from": ["bronze.future_option_mbo.mbo.action=C|M"],
                        "transformation_steps": ["Sum of cancelled/reduced volume at strike bucket in window"]
                    },
                    "pull_qty_rest": {
                        "type": "double",
                        "unit": "contracts",
                        "built_from": ["bronze.future_option_mbo.mbo"],
                        "transformation_steps": ["Sum of cancelled volume from orders resting > 500ms"],
                        "_note": "ALWAYS OUTPUTS ZEROS for performance optimization (tracking removed). Not used by gold layer downstream."
                    },
                    "fill_qty": {
                        "type": "double",
                        "unit": "contracts",
                        "built_from": ["bronze.future_option_mbo.mbo.action=F"],
                        "transformation_steps": ["Sum of filled volume at strike bucket in window"]
                    },
                    "depth_qty_rest": {
                        "type": "double",
                        "unit": "contracts",
                        "built_from": ["bronze.future_option_mbo.mbo"],
                        "transformation_steps": ["Quantity of orders resting for > 500ms, clamped to min(rest, depth_qty_end)"]
                    },
                    "window_valid": {
                        "type": "boolean",
                        "description": "True if spot_ref_price_int > 0"
                    },
                    "accounting_identity_valid": {
                        "type": "boolean",
                        "description": "True if depth_qty_start + add_qty - pull_qty - fill_qty == depth_qty_end. False when grid filtering causes information loss (~8-10%). Use depth_qty_end as authoritative when False."
                    }
                }
            }
        },
        "gold": {
            "GoldComputeOptionPhysicsSurface1s": {
                "_inputs": ["silver.future_option_mbo.depth_and_flow_1s"],
                "physics_surface_1s": {
                    "add_intensity": {
                        "built_from": ["silver.future_option_mbo.depth_and_flow_1s.add_qty", "silver.future_option_mbo.depth_and_flow_1s.depth_qty_start"],
                        "transformation_steps": ["add_qty / (depth_qty_start + 1.0)"]
                    },
                    "fill_intensity": {
                        "built_from": ["silver.future_option_mbo.depth_and_flow_1s.fill_qty", "silver.future_option_mbo.depth_and_flow_1s.depth_qty_start"],
                        "transformation_steps": ["fill_qty / (depth_qty_start + 1.0)"]
                    },
                    "pull_intensity": {
                        "built_from": ["silver.future_option_mbo.depth_and_flow_1s.pull_qty", "silver.future_option_mbo.depth_and_flow_1s.depth_qty_start"],
                        "transformation_steps": ["pull_qty / (depth_qty_start + 1.0)"]
                    },
                    "liquidity_velocity": {
                        "built_from": ["add_intensity", "pull_intensity", "fill_intensity"],
                        "transformation_steps": ["add_intensity - pull_intensity - fill_intensity"],
                        "note": "Net change in liquidity at the strike bucket"
                    },
                    "rho_opt": {
                        "built_from": ["silver.future_option_mbo.depth_and_flow_1s.depth_qty_end"],
                        "transformation_steps": ["log(1 + depth_qty_end)"],
                        "note": "Log-density at strike level"
                    },
                    "phi_rest_opt": {
                        "built_from": ["silver.future_option_mbo.depth_and_flow_1s.depth_qty_rest", "silver.future_option_mbo.depth_and_flow_1s.depth_qty_end"],
                        "transformation_steps": ["depth_qty_rest / (depth_qty_end + 1.0)"],
                        "note": "Persistence fraction for options"
                    },
                    "u_opt_ema_2": {
                        "built_from": ["liquidity_velocity"],
                        "transformation_steps": [
                            "Sort by (strike_price_int, right, side, window_end_ts_ns)",
                            "GroupBy (strike_price_int, right, side)",
                            "EWM(alpha=1-exp(-1/2), adjust=False)"
                        ],
                        "note": "Fast EMA (2s decay) for options"
                    },
                    "u_opt_ema_8": {
                        "built_from": ["liquidity_velocity"],
                        "transformation_steps": [
                            "Sort by (strike_price_int, right, side, window_end_ts_ns)",
                            "GroupBy (strike_price_int, right, side)",
                            "EWM(alpha=1-exp(-1/8), adjust=False)"
                        ],
                        "note": "Mid-scale EMA (8s decay) for options"
                    },
                    "u_opt_ema_32": {
                        "built_from": ["liquidity_velocity"],
                        "transformation_steps": ["GroupBy (strike_price_int, right, side)", "EWM(alpha=1-exp(-1/32), adjust=False)"],
                        "note": "Slow EMA (32s decay) for options"
                    },
                    "u_opt_ema_128": {
                        "built_from": ["liquidity_velocity"],
                        "transformation_steps": ["GroupBy (strike_price_int, right, side)", "EWM(alpha=1-exp(-1/128), adjust=False)"],
                        "note": "Slowest EMA (128s decay) for options"
                    },
                    "u_opt_band_fast": {
                        "built_from": ["u_opt_ema_2", "u_opt_ema_8"],
                        "transformation_steps": ["u_opt_ema_2 - u_opt_ema_8"]
                    },
                    "u_opt_band_mid": {
                        "built_from": ["u_opt_ema_8", "u_opt_ema_32"],
                        "transformation_steps": ["u_opt_ema_8 - u_opt_ema_32"]
                    },
                    "u_opt_band_slow": {
                        "built_from": ["u_opt_ema_32", "u_opt_ema_128"],
                        "transformation_steps": ["u_opt_ema_32 - u_opt_ema_128"]
                    },
                    "u_opt_wave_energy": {
                        "built_from": ["u_opt_band_fast", "u_opt_band_mid", "u_opt_band_slow"],
                        "transformation_steps": ["sqrt(u_opt_band_fast^2 + u_opt_band_mid^2 + u_opt_band_slow^2)"],
                        "note": "Total wave energy across time scales (options)"
                    },
                    "du_opt_dt": {
                        "built_from": ["u_opt_ema_2"],
                        "transformation_steps": ["GroupBy (strike_price_int, right, side)", "diff(u_opt_ema_2) with dt=1s"],
                        "note": "First temporal derivative (options)"
                    },
                    "d2u_opt_dt2": {
                        "built_from": ["du_opt_dt"],
                        "transformation_steps": ["GroupBy (strike_price_int, right, side)", "diff(du_opt_dt) with dt=1s"],
                        "note": "Second temporal derivative (options)"
                    },
                    "u_opt_p": {
                        "built_from": ["phi_rest_opt", "u_opt_ema_8"],
                        "transformation_steps": ["phi_rest_opt * u_opt_ema_8"],
                        "note": "Persistence-weighted mid velocity (options)"
                    },
                    "u_opt_p_slow": {
                        "built_from": ["phi_rest_opt", "u_opt_ema_32"],
                        "transformation_steps": ["phi_rest_opt * u_opt_ema_32"],
                        "note": "Persistence-weighted slow velocity for options"
                    },
                    "u_opt_near": {
                        "built_from": ["u_opt_ema_8"],
                        "transformation_steps": [
                            "Map to rel_strike = rel_ticks / STRIKE_TICKS (bucket index)",
                            "Gaussian convolution on strike grid (n_strikes=round(16/STRIKE_TICKS), sigma=max(1, 6/STRIKE_TICKS))",
                            "Melt back to rel_ticks multiples of STRIKE_TICKS"
                        ],
                        "note": "Near-field spatial smoothing on strike lattice"
                    },
                    "u_opt_far": {
                        "built_from": ["u_opt_ema_32"],
                        "transformation_steps": [
                            "Map to rel_strike = rel_ticks / STRIKE_TICKS (bucket index)",
                            "Gaussian convolution on strike grid (n_strikes=round(64/STRIKE_TICKS), sigma=max(1, 24/STRIKE_TICKS))",
                            "Melt back to rel_ticks multiples of STRIKE_TICKS"
                        ],
                        "note": "Far-field spatial smoothing on strike lattice"
                    },
                    "u_opt_prom": {
                        "built_from": ["u_opt_near", "u_opt_far"],
                        "transformation_steps": ["u_opt_near - u_opt_far"],
                        "note": "Prominence on strike lattice"
                    },
                    "du_opt_dx": {
                        "built_from": ["u_opt_near"],
                        "transformation_steps": ["GroupBy (window_end_ts_ns, right, side)", "(shift(-1) - shift(1)) / (2 * STRIKE_TICKS)"],
                        "note": "Spatial derivative scaled to tick units"
                    },
                    "d2u_opt_dx2": {
                        "built_from": ["u_opt_near"],
                        "transformation_steps": ["GroupBy (window_end_ts_ns, right, side)", "(shift(-1) - 2*u_opt_near + shift(1)) / (STRIKE_TICKS^2)"],
                        "note": "Second spatial derivative scaled to tick units"
                    },
                    "Omega_opt": {
                        "built_from": ["rho_opt", "phi_rest_opt", "u_opt_p_slow"],
                        "transformation_steps": ["rho_opt * (0.5 + 0.5*phi_rest_opt) * (1 + max(0, u_opt_p_slow))"],
                        "note": "Option obstacle strength at strike level"
                    },
                    "Omega_opt_near": {
                        "built_from": ["Omega_opt"],
                        "transformation_steps": ["Gaussian convolution on strike grid (n_strikes=round(16/STRIKE_TICKS), sigma=max(1, 6/STRIKE_TICKS))"]
                    },
                    "Omega_opt_far": {
                        "built_from": ["Omega_opt"],
                        "transformation_steps": ["Gaussian convolution on strike grid (n_strikes=round(64/STRIKE_TICKS), sigma=max(1, 24/STRIKE_TICKS))"]
                    },
                    "Omega_opt_prom": {
                        "built_from": ["Omega_opt_near", "Omega_opt_far"],
                        "transformation_steps": ["Omega_opt_near - Omega_opt_far"],
                        "note": "Obstacle prominence on strike lattice"
                    },
                    "nu_opt": {
                        "built_from": ["Omega_opt_near", "Omega_opt_prom"],
                        "transformation_steps": ["1 + Omega_opt_near + 2*max(0, Omega_opt_prom)"],
                        "note": "Effective viscosity (options)"
                    },
                    "kappa_opt": {
                        "built_from": ["nu_opt"],
                        "transformation_steps": ["1 / nu_opt"],
                        "note": "Permeability (options)"
                    },
                    "pressure_grad_opt": {
                        "built_from": ["u_opt_p", "side"],
                        "transformation_steps": ["If side='B': +u_opt_p, If side='A': -u_opt_p"],
                        "note": "Directional pressure gradient (options)"
                    }
                }
            }
        }
    },
    "streaming": {
        "ForecastEngine": {
            "_description": "Stream-time forecasting using physics fields. Runs per-window during streaming.",
            "_inputs": [
                "gold.future_mbo.physics_surface_1s (per window)",
                "gold.future_option_mbo.physics_surface_1s (per window)"
            ],
            "_output": "forecast surface with horizon_s=30 and diagnostics",
            "directional_fields": {
                "g_dir": {
                    "built_from": ["pressure_grad", "side", "rel_ticks"],
                    "transformation_steps": [
                        "If rel_ticks > 0: use pressure_grad from side='A'",
                        "If rel_ticks < 0: use pressure_grad from side='B'",
                        "If rel_ticks = 0: exclude from force integrals"
                    ],
                    "note": "Directional pressure field on signed tick lattice"
                },
                "u_near_dir": {
                    "built_from": ["u_near", "side", "rel_ticks"],
                    "transformation_steps": [
                        "If rel_ticks > 0: use u_near from side='A'",
                        "If rel_ticks < 0: use u_near from side='B'"
                    ],
                    "note": "Directional rarefaction field"
                },
                "u_p_slow_dir": {
                    "built_from": ["u_p_slow", "side", "rel_ticks"],
                    "transformation_steps": [
                        "If rel_ticks > 0: use u_p_slow from side='A'",
                        "If rel_ticks < 0: use u_p_slow from side='B'"
                    ],
                    "note": "Directional reinforcement field"
                }
            },
            "options_obstacles": {
                "Omega_opt_agg": {
                    "built_from": ["Omega_opt"],
                    "transformation_steps": ["GroupBy rel_ticks", "Sum across right/side"],
                    "note": "Strike-level obstacle mass"
                },
                "Omega_opt_spread": {
                    "built_from": ["Omega_opt_agg"],
                    "transformation_steps": [
                        "Spread with Gaussian kernel sigma=8, radius=24 ticks",
                        "Omega_opt_spread(x) = sum_s Omega_opt(x_s) * K_spread(x - x_s)"
                    ]
                },
                "Omega_total": {
                    "built_from": ["Omega_fut_dir", "Omega_opt_spread"],
                    "transformation_steps": ["Omega_total = Omega_fut_dir + 0.70 * Omega_opt_spread"]
                },
                "Omega_total_prom": {
                    "built_from": ["Omega_total"],
                    "transformation_steps": [
                        "Omega_total_near = GaussianSmooth(Omega_total, sigma=6, radius=16)",
                        "Omega_total_far = GaussianSmooth(Omega_total, sigma=24, radius=64)",
                        "Omega_total_prom = Omega_total_near - Omega_total_far"
                    ]
                },
                "nu_total": {
                    "built_from": ["Omega_total_near", "Omega_total_prom"],
                    "transformation_steps": ["nu_total = 1 + Omega_total_near + 2*max(0, Omega_total_prom)"]
                },
                "kappa_total": {
                    "built_from": ["nu_total"],
                    "transformation_steps": ["kappa_total = 1 / nu_total"]
                }
            },
            "diagnostics": {
                "D_up": {
                    "built_from": ["Omega_total_prom"],
                    "transformation_steps": [
                        "W_up = max_{k=1..64} Omega_total_prom(+k)",
                        "T_up = 0.60 * W_up",
                        "D_up = min{k >= 1 : Omega_total_prom(+k) >= T_up} else 64"
                    ]
                },
                "D_down": {
                    "built_from": ["Omega_total_prom"],
                    "transformation_steps": [
                        "W_down = max_{k=1..64} Omega_total_prom(-k)",
                        "T_down = 0.60 * W_down",
                        "D_down = min{k >= 1 : Omega_total_prom(-k) >= T_down} else 64"
                    ]
                },
                "Vacuum_up": {
                    "built_from": ["u_near_dir", "D_up"],
                    "transformation_steps": [
                        "r(x) = max(0, -u_near_dir(x))",
                        "Vacuum_up = sum_{k=1..D_up-1} w_k * r(+k), w_k=exp(-k/16) renormalized"
                    ]
                },
                "Vacuum_down": {
                    "built_from": ["u_near_dir", "D_down"],
                    "transformation_steps": [
                        "r(x) = max(0, -u_near_dir(x))",
                        "Vacuum_down = sum_{k=1..D_down-1} w_k * r(-k), w_k=exp(-k/16) renormalized"
                    ]
                },
                "Reinforce_up": {
                    "built_from": ["u_p_slow_dir", "D_up"],
                    "transformation_steps": ["Reinforce_up = max(0, u_p_slow_dir(+D_up))"]
                },
                "Reinforce_down": {
                    "built_from": ["u_p_slow_dir", "D_down"],
                    "transformation_steps": ["Reinforce_down = max(0, u_p_slow_dir(-D_down))"]
                },
                "RunScore_up": {
                    "built_from": ["Vacuum_up", "Reinforce_up"],
                    "transformation_steps": ["RunScore_up = Vacuum_up - Reinforce_up"]
                },
                "RunScore_down": {
                    "built_from": ["Vacuum_down", "Reinforce_down"],
                    "transformation_steps": ["RunScore_down = Vacuum_down - Reinforce_down"]
                }
            },
            "force_damping": {
                "F(h)": {
                    "built_from": ["g_dir", "kappa_total", "delta(h)"],
                    "transformation_steps": [
                        "w_force(k) = exp(-k^2/(2*12^2)), normalized over k=1..64",
                        "F(h) = sum_{x=1..64} w_force(|x|) * kappa_total(x - delta(h)) * g_dir(x - delta(h))"
                    ]
                },
                "NuLocal(h)": {
                    "built_from": ["nu_total", "delta(h)"],
                    "transformation_steps": [
                        "w_damp(k) = exp(-k^2/(2*6^2)), normalized over k=1..16",
                        "NuLocal(h) = sum_{x=1..16} w_damp(|x|) * nu_total(x - delta(h))"
                    ]
                }
            },
            "dynamics": {
                "state": ["delta(0)=0", "v(t)=S(t)-S(t-1)"],
                "step": [
                    "a(h) = beta * F(h) / (1 + NuLocal(h))",
                    "v(h+1) = (1 - gamma) * v(h) + a(h)",
                    "delta(h+1) = delta(h) + v(h+1)",
                    "clip v(h) to [-8, 8], clip delta(h) to [-80, 80]"
                ],
                "outputs": [
                    "predicted_tick_delta(h) = round(delta(h))",
                    "predicted_spot_tick(h) = S(t) + predicted_tick_delta(h)"
                ]
            },
            "confidence": {
                "C0": "tanh(|F(0)| / (1 + NuLocal(0)))",
                "Gate": [
                    "If predicted_tick_delta > 0: tanh(max(0, RunScore_up))",
                    "If predicted_tick_delta < 0: tanh(max(0, RunScore_down))",
                    "Else 0"
                ],
                "confidence(h)": "C0 * Gate"
            }
        }
    }
}
