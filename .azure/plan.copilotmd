# Azure Deployment Plan for spymaster Project

## Goal
Deploy the spymaster data pipeline infrastructure with ADLS Gen2, Databricks, Event Hubs, Azure ML, Data Factory, Fabric, and a containerized ingestion service.

## Project Information
- Technology Stack: Python backend, Spark on Databricks, Azure ML + MLflow.
- Application Type: Data engineering and ML pipeline with real-time features.
- Containerization: `backend/Dockerfile`.
- Dependencies: ADLS Gen2, Event Hubs, Databricks, Azure ML, Data Factory, Key Vault, Fabric capacity.

## Azure Resources Architecture
```mermaid
graph LR
  Ingestor[Container App: databento_stream_ingestor] --> EH[Event Hubs Namespace]
  EH --> DBX[Databricks]
  DBX --> ADLS[ADLS Gen2]
  ADF[Data Factory] --> DBX
  ADLS --> AML[Azure ML]
  DBX --> AML
  EH --> Fabric[Fabric Eventstream/Eventhouse]
  AML --> EH
  KV[Key Vault] --> Ingestor
  KV --> DBX
```
- Ingestor publishes to `mbo_raw`.
- Databricks reads `mbo_raw`, writes Bronze/Silver/Gold to ADLS, publishes `features_gold` and `inference_scores`.
- Azure ML trains on exported snapshots from ADLS and exposes managed endpoints.
- Fabric consumes `features_gold` and `inference_scores` for dashboards.

## Recommended Azure Resources
- Application spymaster-ingestor
  - Hosting Service Type: Azure Container Apps
  - SKU: Consumption
  - Configuration:
    - language: python
    - dockerFilePath: /Users/loganrobbins/research/qmachina/spymaster/backend/Dockerfile
    - dockerContext: /Users/loganrobbins/research/qmachina/spymaster/backend
    - Environment Variables: EVENTHUB_NAMESPACE, EVENTHUB_MBO_RAW, KEYVAULT_NAME
  - Dependencies Resource
    - Azure Event Hubs (Standard)
    - Azure Storage (Standard_LRS)
    - Azure Databricks (Premium)
    - Azure Machine Learning (Basic)
    - Azure Data Factory
    - Azure Key Vault (RBAC enabled)
    - Microsoft Fabric Capacity

Recommended Supporting Services
- Log Analytics Workspace
- Application Insights
- Container Registry (reuse AML ACR)

Recommended Security Configurations
- Managed identities for Container Apps, Databricks, Azure ML
- Event Hubs Data Sender/Receiver role assignments
- Key Vault Secrets User role assignments
- Storage key access disabled; use Microsoft Entra auth

## Execution Step
1. Provision Azure Infrastructure:
   1. Validate with `az deployment group what-if` using `infra/main.bicep` and `infra/params/dev.bicepparam`.
   2. Deploy with `az deployment group create`.
2. Build and Deploy the Application:
   1. Build and push the ingestion container image.
   2. Deploy to Azure Container Apps.
3. Validation:
   1. Verify resource creation with `az resource list` and `az eventhubs namespace show`.
   2. Verify ingestion container health and Event Hubs metrics.
