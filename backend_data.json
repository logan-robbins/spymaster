{
    "description": "Schema definitions for Spymaster backend Silver layer. For LLM/AI consumption.",
    "pipelines": {
        "future_mbo": {
            "description": "Futures MBO to HUD surfaces",
            "silver_stages": [
                {
                    "order": 1,
                    "stage": "SilverComputeSnapshotAndWall1s",
                    "inputs": [
                        "bronze.future_mbo.mbo"
                    ],
                    "outputs": [
                        "silver.future_mbo.book_snapshot_1s",
                        "silver.future_mbo.wall_surface_1s",
                        "silver.future_mbo.radar_vacuum_1s"
                    ]
                },
                {
                    "order": 2,
                    "stage": "SilverComputeVacuumSurface1s",
                    "inputs": [
                        "silver.future_mbo.wall_surface_1s",
                        "gold.hud.physics_norm_calibration"
                    ],
                    "outputs": [
                        "silver.future_mbo.vacuum_surface_1s"
                    ]
                },
                {
                    "order": 3,
                    "stage": "SilverComputeRadarVacuum1s",
                    "inputs": [
                        "bronze.future_mbo.mbo"
                    ],
                    "outputs": [
                        "silver.future_mbo.radar_vacuum_1s"
                    ],
                    "note": "NO-OP if radar already exists from stage 1"
                },
                {
                    "order": 4,
                    "stage": "SilverComputePhysicsBands1s",
                    "inputs": [
                        "silver.future_mbo.book_snapshot_1s",
                        "silver.future_mbo.wall_surface_1s",
                        "silver.future_mbo.vacuum_surface_1s",
                        "gold.hud.physics_norm_calibration"
                    ],
                    "outputs": [
                        "silver.future_mbo.physics_bands_1s"
                    ]
                },
                {
                    "order": 5,
                    "stage": "SilverComputePhysicsSurface1s",
                    "inputs": [
                        "silver.future_mbo.book_snapshot_1s",
                        "silver.future_mbo.wall_surface_1s",
                        "silver.future_mbo.vacuum_surface_1s",
                        "gold.hud.physics_norm_calibration"
                    ],
                    "outputs": [
                        "silver.future_mbo.physics_surface_1s"
                    ]
                },
                {
                    "order": 6,
                    "stage": "SilverComputeBucketRadar1s",
                    "inputs": [
                        "silver.future_mbo.wall_surface_1s",
                        "silver.future_mbo.vacuum_surface_1s",
                        "silver.future_option_mbo.gex_surface_1s",
                        "gold.hud.physics_norm_calibration"
                    ],
                    "outputs": [
                        "silver.future_mbo.bucket_radar_surface_1s"
                    ]
                }
            ]
        },
        "future_option_mbo": {
            "description": "Options MBO to GEX surface",
            "silver_stages": [
                {
                    "order": 1,
                    "stage": "SilverComputeStatisticsClean",
                    "inputs": [
                        "bronze.future_option.statistics"
                    ],
                    "outputs": [
                        "silver.future_option.statistics_clean"
                    ]
                },
                {
                    "order": 2,
                    "stage": "SilverComputeGexSurface1s",
                    "inputs": [
                        "bronze.future_option_mbo.mbo",
                        "silver.future_mbo.book_snapshot_1s",
                        "silver.future_option.statistics_clean",
                        "bronze.shared.instrument_definitions"
                    ],
                    "outputs": [
                        "silver.future_option_mbo.gex_surface_1s",
                        "silver.future_option_mbo.book_wall_1s",
                        "silver.future_option_mbo.book_flow_1s"
                    ]
                }
            ]
        }
    },
    "stream_mapping": {
        "snap": "silver.future_mbo.book_snapshot_1s",
        "wall": "silver.future_mbo.wall_surface_1s",
        "vacuum": "silver.future_mbo.vacuum_surface_1s",
        "radar": "silver.future_mbo.radar_vacuum_1s",
        "physics": "silver.future_mbo.physics_surface_1s",
        "gex": "silver.future_option_mbo.gex_surface_1s",
        "options_wall": "silver.future_option_mbo.book_wall_1s",
        "options_flow": "silver.future_option_mbo.book_flow_1s",
        "bucket_radar": "silver.future_mbo.bucket_radar_surface_1s"
    },
    "datasets": {
        "silver.future_mbo.book_snapshot_1s": {
            "frontend_stream": "snap",
            "produced_by": "SilverComputeSnapshotAndWall1s",
            "description": "1-second Top-of-Book snapshot. Primary spot anchor.",
            "fields": {
                "window_start_ts_ns": {
                    "type": "long",
                    "desc": "Window start (ns)"
                },
                "window_end_ts_ns": {
                    "type": "long",
                    "desc": "Window end (ns)"
                },
                "best_bid_price_int": {
                    "type": "long",
                    "desc": "Best Bid (scaled int)"
                },
                "best_bid_qty": {
                    "type": "long",
                    "desc": "Qty at Best Bid"
                },
                "best_ask_price_int": {
                    "type": "long",
                    "desc": "Best Ask (scaled int)"
                },
                "best_ask_qty": {
                    "type": "long",
                    "desc": "Qty at Best Ask"
                },
                "mid_price": {
                    "type": "double",
                    "desc": "Mid Price real units"
                },
                "mid_price_int": {
                    "type": "long",
                    "desc": "Mid Price scaled"
                },
                "last_trade_price_int": {
                    "type": "long",
                    "desc": "Last Trade scaled"
                },
                "spot_ref_price_int": {
                    "type": "long",
                    "desc": "Grid-aligned (20 ticks) spot anchor for rel_ticks"
                },
                "book_valid": {
                    "type": "boolean",
                    "desc": "Book state valid"
                }
            },
            "transformations": [
                {
                    "step": 1,
                    "action": "If best_bid_price_int>0 and best_ask_price_int>0 compute mid_price + mid_price_int, else set both to 0"
                },
                {
                    "step": 2,
                    "field": "mid_price",
                    "formula": "(best_bid_price_int + best_ask_price_int) * 0.5 * PRICE_SCALE"
                },
                {
                    "step": 3,
                    "field": "mid_price_int",
                    "formula": "round((best_bid_price_int + best_ask_price_int) * 0.5)"
                },
                {
                    "step": 4,
                    "field": "spot_ref_price_int",
                    "formula": "raw_spot = (last_trade_price_int > 0) ? last_trade_price_int : ((book_valid && best_bid_price_int > 0) ? best_bid_price_int : 0)"
                },
                {
                    "step": 5,
                    "field": "spot_ref_price_int",
                    "formula": "if raw_spot>0 then round(raw_spot / (GRID_ALIGN_TICKS*TICK_INT)) * (GRID_ALIGN_TICKS*TICK_INT) else 0"
                }
            ]
        },
        "silver.future_mbo.wall_surface_1s": {
            "frontend_stream": "wall",
            "produced_by": "SilverComputeSnapshotAndWall1s",
            "description": "Liquidity Wall. Per-price-level order book dynamics.",
            "spatial": true,
            "fields": {
                "window_start_ts_ns": {
                    "type": "long"
                },
                "window_end_ts_ns": {
                    "type": "long"
                },
                "price_int": {
                    "type": "long",
                    "desc": "Price level scaled"
                },
                "side": {
                    "type": "string",
                    "desc": "'B' or 'A'"
                },
                "spot_ref_price_int": {
                    "type": "long",
                    "desc": "Grid-aligned spot anchor"
                },
                "rel_ticks": {
                    "type": "int",
                    "desc": "Ticks from spot"
                },
                "depth_qty_start": {
                    "type": "double",
                    "desc": "Depth at window start"
                },
                "depth_qty_end": {
                    "type": "double",
                    "desc": "Depth at window end"
                },
                "add_qty": {
                    "type": "double",
                    "desc": "Orders added"
                },
                "pull_qty_total": {
                    "type": "double",
                    "desc": "Total cancellations"
                },
                "depth_qty_rest": {
                    "type": "double",
                    "desc": "Resting depth (>500ms)"
                },
                "pull_qty_rest": {
                    "type": "double",
                    "desc": "Rested order cancellations"
                },
                "fill_qty": {
                    "type": "double",
                    "desc": "Filled by trades"
                },
                "d1_depth_qty": {
                    "type": "double",
                    "desc": "Depth velocity"
                },
                "d2_depth_qty": {
                    "type": "double",
                    "desc": "Depth acceleration"
                },
                "d3_depth_qty": {
                    "type": "double",
                    "desc": "Depth jerk"
                },
                "window_valid": {
                    "type": "boolean"
                }
            },
            "transformations": [
                {
                    "step": 1,
                    "field": "rel_ticks",
                    "formula": "round((price_int - spot_ref) / TICK_INT)"
                },
                {
                    "step": 2,
                    "field": "depth_qty_start",
                    "formula": "max(depth_end - add + pull + fill, 0)"
                },
                {
                    "step": 3,
                    "field": "depth_qty_rest",
                    "formula": "sum(qty) of resting orders at window_end_ts_ns where (window_end_ts_ns - order.ts_enter) >= REST_NS"
                },
                {
                    "step": 4,
                    "field": "pull_qty_rest",
                    "formula": "sum(qty) of cancellations for orders with age >= REST_NS within the window"
                },
                {
                    "step": 5,
                    "action": "Accumulate per-price add_qty, pull_qty_total, fill_qty over events in the 1s window"
                },
                {
                    "step": 6,
                    "field": "d1_depth_qty",
                    "formula": "depth_end[t] - depth_end[t-1]"
                },
                {
                    "step": 7,
                    "field": "d2_depth_qty",
                    "formula": "d1[t] - d1[t-1]"
                },
                {
                    "step": 8,
                    "field": "d3_depth_qty",
                    "formula": "d2[t] - d2[t-1]"
                },
                {
                    "step": 9,
                    "field": "window_valid",
                    "formula": "book_valid && !window_has_snapshot"
                }
            ]
        },
        "silver.future_mbo.radar_vacuum_1s": {
            "frontend_stream": "radar",
            "frontend_used": false,
            "produced_by": "SilverComputeSnapshotAndWall1s",
            "description": "~200 ML features for order book microstructure. Reserved for model inference, not visualization.",
            "feature_count": 196,
            "fields": {
                "window_start_ts_ns": {
                    "type": "long"
                },
                "window_end_ts_ns": {
                    "type": "long"
                },
                "spot_ref_price": {
                    "type": "double",
                    "desc": "spot_ref_price_int * PRICE_SCALE"
                },
                "spot_ref_price_int": {
                    "type": "long",
                    "desc": "Grid-aligned (20 ticks) spot anchor"
                },
                "approach_dir": {
                    "type": "string",
                    "desc": "'approach_up'|'approach_down'|'approach_none'"
                }
            },
            "feature_groups": {
                "base_features": {
                    "prefix": "f",
                    "count": 25,
                    "buckets": {
                        "at": "0-2 ticks",
                        "near": "3-5",
                        "mid": "6-14",
                        "far": "15-20"
                    },
                    "key_features": [
                        {
                            "name": "f1_ask_com_disp_log",
                            "formula": "log((d_ask_ticks_end + EPS_DIST_TICKS) / (d_ask_ticks_start + EPS_DIST_TICKS))",
                            "desc": "Ask COM displacement (ticks)"
                        },
                        {
                            "name": "f1_ask_slope_convex_log",
                            "formula": "log((ask_depth_far + EPS_QTY) / (ask_depth_near + EPS_QTY))",
                            "desc": "Book convexity"
                        },
                        {
                            "name": "f2_ask_pull_add_log_rest",
                            "formula": "log((ask_pull_rest_qty + EPS_QTY) / (ask_add_qty + EPS_QTY))",
                            "desc": "Pull/add ratio"
                        },
                        {
                            "name": "f5_vacuum_expansion_log",
                            "formula": "f1_ask + f3_bid",
                            "desc": "Combined COM"
                        },
                        {
                            "name": "f6_vacuum_decay_log",
                            "formula": "f2_ask_pull_add_log_rest + f4_bid_pull_add_log_rest",
                            "desc": "Combined pull/add"
                        },
                        {
                            "name": "f7_vacuum_total_log",
                            "formula": "f5 + f6",
                            "desc": "Overall vacuum"
                        }
                    ]
                },
                "up_features": {
                    "prefix": "u",
                    "count": 24,
                    "desc": "Directional up-move features",
                    "key_features": [
                        {
                            "name": "u8_bid_com_approach_log",
                            "formula": "-f3_bid_com_disp_log",
                            "desc": "Bid support approaching"
                        },
                        {
                            "name": "u17_up_total_log",
                            "formula": "u15 + u16",
                            "desc": "Overall up signal"
                        }
                    ]
                },
                "derivatives": {
                    "pattern": "d{1,2,3}_{feature}",
                    "applied_to": "all 49 base+up features"
                }
            },
            "transformations": [
                {
                    "step": 1,
                    "action": "Build start/end snapshots from depth within ±20 ticks of spot_ref_price_int (buckets: at<=2, near<=5, mid<=14, far>=15)"
                },
                {
                    "step": 2,
                    "action": "Compute depth totals, bucket shares, COM distances (d_ask_ticks, d_bid_ticks), and BBO distances"
                },
                {
                    "step": 3,
                    "action": "Accumulate add/pull/reprice metrics from window events with rest threshold REST_NS"
                },
                {
                    "step": 4,
                    "action": "Compute base features f1..f9 (ask/bid) from start/end snapshots and accumulators"
                },
                {
                    "step": 5,
                    "action": "Compute vacuum features f5..f7 and up features u1..u19 derived from base"
                },
                {
                    "step": 6,
                    "action": "Compute d1/d2/d3 for all 49 base+up features using prior window values"
                },
                {
                    "step": 7,
                    "action": "Compute approach_dir from 4-window spot_ref_price_int trend (current - 3 windows ago)"
                }
            ]
        },
        "silver.future_mbo.vacuum_surface_1s": {
            "frontend_stream": "vacuum",
            "produced_by": "SilverComputeVacuumSurface1s",
            "description": "Vacuum physics. Per-level pull forces.",
            "spatial": true,
            "fields": {
                "window_start_ts_ns": {
                    "type": "long"
                },
                "window_end_ts_ns": {
                    "type": "long"
                },
                "price_int": {
                    "type": "long"
                },
                "side": {
                    "type": "string"
                },
                "spot_ref_price_int": {
                    "type": "long",
                    "desc": "Grid-aligned spot anchor"
                },
                "rel_ticks": {
                    "type": "int"
                },
                "pull_intensity_rest": {
                    "type": "double",
                    "desc": "Fraction pulled"
                },
                "pull_add_log": {
                    "type": "double",
                    "desc": "Log(pull/add)"
                },
                "d1_pull_add_log": {
                    "type": "double"
                },
                "d2_pull_add_log": {
                    "type": "double"
                },
                "d3_pull_add_log": {
                    "type": "double"
                },
                "wall_strength_log": {
                    "type": "double",
                    "desc": "Log wall size"
                },
                "wall_erosion": {
                    "type": "double",
                    "desc": "Decay rate"
                },
                "vacuum_score": {
                    "type": "double",
                    "desc": "0-1 normalized composite"
                },
                "window_valid": {
                    "type": "boolean"
                }
            },
            "transformations": [
                {
                    "step": 1,
                    "field": "pull_intensity_rest",
                    "formula": "pull_qty_rest / (depth_start + EPS)",
                    "source": "wall_surface"
                },
                {
                    "step": 2,
                    "field": "pull_add_log",
                    "formula": "log((pull_rest + EPS) / (add + EPS))",
                    "source": "wall_surface"
                },
                {
                    "step": 3,
                    "field": "wall_erosion",
                    "formula": "max(-d1_depth_qty, 0)",
                    "source": "wall_surface"
                },
                {
                    "step": 4,
                    "field": "wall_strength_log",
                    "formula": "log(depth_rest + 1)",
                    "source": "wall_surface"
                },
                {
                    "step": 5,
                    "field": "d1_pull_add_log",
                    "formula": "diff(pull_add_log) over time per (side, price_int), fill missing with 0"
                },
                {
                    "step": 6,
                    "field": "d2_pull_add_log",
                    "formula": "diff(d1_pull_add_log) per (side, price_int)"
                },
                {
                    "step": 7,
                    "field": "d3_pull_add_log",
                    "formula": "diff(d2_pull_add_log) per (side, price_int)"
                },
                {
                    "step": 8,
                    "field": "vacuum_score",
                    "formula": "(n1 + n2 + n3 + n4) / 4",
                    "components": {
                        "n1": "norm(pull_add_log)",
                        "n2": "norm(log1p(pull_intensity_rest))",
                        "n3": "norm(log1p(wall_erosion / (depth_start + EPS)))",
                        "n4": "norm(d2_pull_add_log)"
                    },
                    "norm": "clip((val - q05) / (q95 - q05), 0, 1)",
                    "calibration": "gold.hud.physics_norm_calibration"
                }
            ]
        },
        "silver.future_mbo.physics_bands_1s": {
            "frontend_stream": "physics",
            "produced_by": "SilverComputePhysicsBands1s",
            "description": "Aggregated physics by spatial band.",
            "bands": {
                "at": [
                    0,
                    2
                ],
                "near": [
                    3,
                    5
                ],
                "mid": [
                    6,
                    14
                ],
                "far": [
                    15,
                    20
                ]
            },
            "directions": [
                "above",
                "below"
            ],
            "fields": {
                "window_start_ts_ns": {
                    "type": "long"
                },
                "window_end_ts_ns": {
                    "type": "long"
                },
                "spot_ref_price_int": {
                    "type": "long",
                    "desc": "Grid-aligned spot anchor"
                },
                "mid_price": {
                    "type": "double"
                },
                "mid_price_int": {
                    "type": "long"
                },
                "{dir}_{band}_wall_strength_norm": {
                    "type": "double",
                    "desc": "0-1"
                },
                "{dir}_{band}_wall_erosion_norm": {
                    "type": "double",
                    "desc": "0-1"
                },
                "{dir}_{band}_vacuum_norm": {
                    "type": "double",
                    "desc": "0-1"
                },
                "above_score": {
                    "type": "double",
                    "desc": "Ease-of-movement up"
                },
                "below_score": {
                    "type": "double",
                    "desc": "Ease-of-movement down"
                },
                "vacuum_total_score": {
                    "type": "double"
                }
            },
            "transformations": [
                {
                    "step": 1,
                    "action": "Filter wall_surface to valid bands by |rel_ticks|"
                },
                {
                    "step": 2,
                    "action": "Assign direction: above if side=A & rel>0, below if side=B & rel<0"
                },
                {
                    "step": 3,
                    "field": "wall_strength_log",
                    "formula": "log(depth_rest + 1)"
                },
                {
                    "step": 4,
                    "field": "log1p_erosion",
                    "formula": "log1p(max(-d1_depth, 0) / (depth_start + EPS))"
                },
                {
                    "step": 5,
                    "action": "Aggregate mean(wall_strength_log, erosion) by (window, dir, band)"
                },
                {
                    "step": 6,
                    "action": "Join vacuum_surface, aggregate mean(vacuum_score)"
                },
                {
                    "step": 7,
                    "field": "wall_strength_norm",
                    "formula": "norm(wall_strength_log)"
                },
                {
                    "step": 8,
                    "field": "wall_erosion_norm",
                    "formula": "norm(log1p_erosion)"
                },
                {
                    "step": 9,
                    "field": "ease (hidden)",
                    "formula": "0.50*vacuum_norm + 0.35*wall_erosion_norm + 0.15*(1 - wall_strength_norm)"
                },
                {
                    "step": 10,
                    "field": "above_score",
                    "formula": "0.60*above_at_ease + 0.40*above_near_ease"
                },
                {
                    "step": 11,
                    "field": "below_score",
                    "formula": "0.60*below_at_ease + 0.40*below_near_ease"
                },
                {
                    "step": 12,
                    "field": "vacuum_total_score",
                    "formula": "(above_score + below_score) / 2"
                }
            ]
        },
        "silver.future_mbo.physics_surface_1s": {
            "frontend_stream": "physics",
            "produced_by": "SilverComputePhysicsSurface1s",
            "description": "Per-tick physics score (ease of movement).",
            "spatial": true,
            "fields": {
                "window_end_ts_ns": {
                    "type": "long"
                },
                "event_ts_ns": {
                    "type": "long"
                },
                "spot_ref_price_int": {
                    "type": "long"
                },
                "rel_ticks": {
                    "type": "int"
                },
                "side": {
                    "type": "string"
                },
                "physics_score": {
                    "type": "double",
                    "desc": "Absolute physics score 0..1"
                },
                "physics_score_signed": {
                    "type": "double",
                    "desc": "+ve for upward ease, -ve for downward ease"
                }
            },
            "transformations": [
                {
                    "step": 1,
                    "action": "Outer-join wall_surface and vacuum_surface on (window_end_ts_ns, rel_ticks)"
                },
                {
                    "step": 2,
                    "action": "Compute wall_strength_log = log(depth_qty_rest+1) and log1p_erosion_norm = log1p(max(-d1_depth_qty,0)/(depth_qty_start+EPS)) from wall_surface"
                },
                {
                    "step": 3,
                    "action": "Normalize wall_strength_log and log1p_erosion_norm using gold.hud.physics_norm_calibration bounds"
                },
                {
                    "step": 4,
                    "action": "Set vacuum_norm = vacuum_score; fill missing wall/vacuum values with 0.0"
                },
                {
                    "step": 5,
                    "action": "If side missing (vacuum-only tick), infer side from rel_ticks (rel>0 => A, rel<0 => B)"
                },
                {
                    "step": 6,
                    "field": "physics_score",
                    "formula": "0.50*vacuum_norm + 0.35*wall_erosion_norm + 0.15*(1 - wall_strength_norm)"
                },
                {
                    "step": 7,
                    "field": "physics_score_signed",
                    "formula": "+physics_score if side=A & rel_ticks>0, -physics_score if side=B & rel_ticks<0, else 0"
                },
                {
                    "step": 8,
                    "action": "Join snapshot on window_end_ts_ns to set spot_ref_price_int; event_ts_ns = window_end_ts_ns"
                }
            ]
        },
        "silver.future_mbo.bucket_radar_surface_1s": {
            "frontend_stream": "bucket_radar",
            "produced_by": "SilverComputeBucketRadar1s",
            "description": "Bucket-native (2-tick) radar surface combining wall, vacuum, and gex.",
            "spatial": true,
            "fields": {
                "window_end_ts_ns": {
                    "type": "long"
                },
                "bucket_rel": {
                    "type": "int",
                    "desc": "Bucket index relative to spot (0=spot). 1 bucket = 2 ticks."
                },
                "blocked_level": {
                    "type": "int",
                    "desc": "0..5 integer resistance level."
                },
                "cavitation": {
                    "type": "double",
                    "desc": "0..1 vacuum visibility."
                },
                "gex_stiffness": {
                    "type": "double",
                    "desc": "0..1 gamma barrier strength."
                },
                "mobility": {
                    "type": "double",
                    "desc": "0..1 ease of movement."
                },
                "spot_ref_price_int": {
                    "type": "long"
                }
            },
            "transformations": [
                {
                    "step": 1,
                    "action": "Load Wall, Vacuum, GEX, Calibration."
                },
                {
                    "step": 2,
                    "action": "Normalize Wall Mass using calibration."
                },
                {
                    "step": 3,
                    "action": "Join Wall and Vacuum on valid ticks."
                },
                {
                    "step": 4,
                    "action": "Bucketize ticks: bucket_rel = floor(rel_ticks / 2)."
                },
                {
                    "step": 5,
                    "action": "Aggregate Mass (mean) and Vacuum (mean) per bucket."
                },
                {
                    "step": 6,
                    "action": "Join GEX (bucket_rel = floor(rel_ticks / 2))."
                },
                {
                    "step": 7,
                    "action": "Compute R0 = clamp(mass + gex, 0, 1)."
                },
                {
                    "step": 8,
                    "action": "Compute R_eff = R0 * (1 - vacuum)."
                },
                {
                    "step": 9,
                    "action": "Output BlockedLevel = round(5 * R_eff), Cavitation = vacuum^1.5."
                }
            ]
        },
        "silver.future_option.statistics_clean": {
            "produced_by": "SilverComputeStatisticsClean",
            "description": "Deduped options open interest.",
            "fields": {
                "ts_event_ns": {
                    "type": "long"
                },
                "ts_event_est": {
                    "type": "string"
                },
                "ts_recv_ns": {
                    "type": "long"
                },
                "source": {
                    "type": "string"
                },
                "underlying": {
                    "type": "string"
                },
                "option_symbol": {
                    "type": "string"
                },
                "exp_date": {
                    "type": [
                        "null",
                        "string"
                    ]
                },
                "strike": {
                    "type": "double"
                },
                "right": {
                    "type": "string"
                },
                "open_interest": {
                    "type": "double"
                }
            },
            "transformations": [
                {
                    "step": 1,
                    "action": "Sort by ts_event_ns"
                },
                {
                    "step": 2,
                    "action": "Group by option_symbol, take last"
                }
            ]
        },
        "silver.future_option_mbo.gex_surface_1s": {
            "frontend_stream": "gex",
            "produced_by": "SilverComputeGexSurface1s",
            "description": "Gamma Exposure from 0DTE options.",
            "spatial": true,
            "grid": {
                "step": 5,
                "offsets": 12,
                "range": "±60 points"
            },
            "fields": {
                "window_start_ts_ns": {
                    "type": "long"
                },
                "window_end_ts_ns": {
                    "type": "long"
                },
                "underlying": {
                    "type": "string"
                },
                "strike_price_int": {
                    "type": "long"
                },
                "underlying_spot_ref": {
                    "type": "double"
                },
                "spot_ref_price_int": {
                    "type": "long",
                    "desc": "Tick-aligned spot anchor (integer, 20-tick grid)"
                },
                "rel_ticks": {
                    "type": "int",
                    "desc": "Ticks relative to spot_ref_price_int"
                },
                "strike_points": {
                    "type": "double"
                },
                "gex_call_abs": {
                    "type": "double"
                },
                "gex_put_abs": {
                    "type": "double"
                },
                "gex_abs": {
                    "type": "double"
                },
                "gex": {
                    "type": "double"
                },
                "gex_imbalance_ratio": {
                    "type": "double"
                },
                "d1_gex_abs": {
                    "type": "double"
                },
                "d2_gex_abs": {
                    "type": "double"
                },
                "d3_gex_abs": {
                    "type": "double"
                },
                "d1_gex": {
                    "type": "double"
                },
                "d2_gex": {
                    "type": "double"
                },
                "d3_gex": {
                    "type": "double"
                },
                "d1_gex_imbalance_ratio": {
                    "type": "double"
                },
                "d2_gex_imbalance_ratio": {
                    "type": "double"
                },
                "d3_gex_imbalance_ratio": {
                    "type": "double"
                }
            },
            "transformations": [
                {
                    "step": 1,
                    "action": "Filter instrument_definitions to C/P options with expiration date == session_date (Etc/GMT+5), keep last per instrument_id"
                },
                {
                    "step": 2,
                    "action": "Load open interest and filter to option_symbol with OI > 0"
                },
                {
                    "step": 3,
                    "action": "Filter option MBO to eligible instrument_ids and compute per-window BBO mid_price per instrument"
                },
                {
                    "step": 4,
                    "action": "Join futures spot_ref_price_int from book_snapshot_1s and set spot_ref_price = spot_ref_price_int * PRICE_SCALE"
                },
                {
                    "step": 5,
                    "action": "Filter strikes to ±60 points around round(spot_ref_price/5)*5 and keep T>0"
                },
                {
                    "step": 6,
                    "field": "T",
                    "formula": "(expiration_ns - window_end_ts_ns) / 1e9 / 86400 / 365"
                },
                {
                    "step": 7,
                    "field": "iv",
                    "formula": "Newton-Raphson (3 iter) on BS price (vectorized)"
                },
                {
                    "step": 8,
                    "field": "d1",
                    "formula": "(ln(F/K) + 0.5*iv²*T) / (iv*√T)"
                },
                {
                    "step": 9,
                    "field": "gamma",
                    "formula": "e^(-rT) * N'(d1) / (F * iv * √T)"
                },
                {
                    "step": 10,
                    "field": "gex_val",
                    "formula": "gamma * open_interest * CONTRACT_MULTIPLIER"
                },
                {
                    "step": 11,
                    "action": "Build strike grid per window: strike_ref = round(spot_ref_price/5)*5; offsets [-12..12]*5; compute strike_points, strike_price_int, rel_ticks"
                },
                {
                    "step": 12,
                    "action": "Aggregate gex_val by (window_end_ts_ns, strike_price, is_call) and pivot to gex_call_abs/gex_put_abs"
                },
                {
                    "step": 13,
                    "field": "gex_abs",
                    "formula": "gex_call_abs + gex_put_abs"
                },
                {
                    "step": 14,
                    "field": "gex",
                    "formula": "gex_call_abs - gex_put_abs"
                },
                {
                    "step": 15,
                    "field": "gex_imbalance_ratio",
                    "formula": "gex / (gex_abs + EPS_GEX)"
                },
                {
                    "step": 16,
                    "action": "Compute d1/d2/d3 for gex_abs, gex, gex_imbalance_ratio by strike_price_int over time"
                },
                {
                    "step": 17,
                    "action": "Set window_start_ts_ns = window_end_ts_ns - WINDOW_NS and underlying_spot_ref = spot_ref_price"
                }
            ]
        },
        "silver.future_option_mbo.book_wall_1s": {
            "frontend_stream": "options_wall",
            "produced_by": "SilverComputeGexSurface1s",
            "description": "Options Liquidity Wall. Per-instrument order book depth.",
            "fields": {
                "window_end_ts_ns": {
                    "type": "long"
                },
                "strike_price_int": {
                    "type": "long",
                    "desc": "Underlying strike"
                },
                "side": {
                    "type": "string",
                    "desc": "'A' or 'B'"
                },
                "right": {
                    "type": "string",
                    "desc": "'C' or 'P'"
                },
                "depth_total": {
                    "type": "long",
                    "desc": "Aggregated depth"
                },
                "add_qty": {
                    "type": "long"
                },
                "pull_qty": {
                    "type": "long"
                },
                "pull_rest_qty": {
                    "type": "long"
                },
                "fill_qty": {
                    "type": "long"
                }
            }
        },
        "silver.future_option_mbo.book_flow_1s": {
            "frontend_stream": "options_flow",
            "produced_by": "SilverComputeGexSurface1s",
            "description": "Options Flow. Net flow metrics.",
            "fields": {
                "window_end_ts_ns": {
                    "type": "long"
                },
                "strike_price_int": {
                    "type": "long"
                },
                "side": {
                    "type": "string"
                },
                "right": {
                    "type": "string"
                },
                "add_qty": {
                    "type": "long"
                },
                "pull_qty": {
                    "type": "long"
                },
                "fill_qty": {
                    "type": "long"
                }
            }
        }
    },
    "calibration": {
        "dataset": "gold.hud.physics_norm_calibration",
        "norm_function": "clip((val - q05) / (q95 - q05), 0, 1)",
        "metrics": [
            "pull_add_log",
            "log1p_pull_intensity_rest",
            "log1p_erosion_norm",
            "d2_pull_add_log",
            "wall_strength_log",
            "gex_abs"
        ]
    },
    "constants": {
        "WINDOW_NS": 1000000000,
        "REST_NS": 500000000,
        "TICK_SIZE": 0.25,
        "TICK_INT": 250000000,
        "GRID_ALIGN_TICKS": 20,
        "PRICE_SCALE": 1e-9,
        "EPS_QTY": 1.0,
        "EPS_DIST_TICKS": 1.0,
        "EPS_GEX": 1e-6,
        "GEX_STRIKE_STEP_POINTS": 5,
        "GEX_MAX_STRIKE_OFFSETS": 12,
        "CONTRACT_MULTIPLIER": 50,
        "RISK_FREE_RATE": 0.05
    }
}