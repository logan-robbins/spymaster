{
    "description": "Streaming schema for Spymaster HUD. Defines EXACTLY what backend streams to frontend for visualization.",
    "protocol": {
        "transport": "WebSocket",
        "endpoint": "ws://localhost:8000/v1/hud/stream",
        "format": "Arrow IPC",
        "cadence": "1 second windows",
        "framing": {
            "control_frames": [
                {
                    "type": "batch_start",
                    "fields": [
                        "window_end_ts_ns",
                        "surfaces"
                    ],
                    "desc": "Marks new window and lists surfaces included in this batch. window_end_ts_ns is serialized as string in JSON; parse to BigInt."
                },
                {
                    "type": "surface_header",
                    "fields": [
                        "surface",
                        "window_end_ts_ns"
                    ],
                    "desc": "Header immediately preceding the binary Arrow IPC payload for the surface. window_end_ts_ns is serialized as string."
                }
            ],
            "binary_frame": "Arrow IPC stream for the surface named in the preceding surface_header"
        }
    },
    "streams": {
        "snap": {
            "description": "Top-of-Book snapshot. Provides spot price anchor for visualization.",
            "rows_per_window": 1,
            "fields": [
                {
                    "name": "window_end_ts_ns",
                    "type": "long",
                    "required": true,
                    "desc": "Window end timestamp (ns)"
                },
                {
                    "name": "mid_price",
                    "type": "double",
                    "required": true,
                    "desc": "Mid price for spot line. Frontend uses this for price axis."
                },
                {
                    "name": "spot_ref_price_int",
                    "type": "long",
                    "required": true,
                    "desc": "Tick-aligned spot anchor (integer, 20-tick grid)."
                },
                {
                    "name": "book_valid",
                    "type": "boolean",
                    "required": true,
                    "desc": "False during snapshot recovery"
                }
            ],
            "frontend_usage": {
                "component": "state.ts:setSpotData, main.ts:spotEl",
                "purpose": "Draws cyan spot price line, updates spot metric display"
            }
        },
        "wall": {
            "description": "Liquidity Wall. Resting order depth per price level.",
            "rows_per_window": "variable (one per active price level within ±400 ticks)",
            "spatial": true,
            "fields": [
                {
                    "name": "window_end_ts_ns",
                    "type": "long",
                    "required": true,
                    "desc": "Window timestamp"
                },
                {
                    "name": "rel_ticks",
                    "type": "int",
                    "required": true,
                    "desc": "Ticks from spot. +N = above, -N = below"
                },
                {
                    "name": "side",
                    "type": "string",
                    "required": true,
                    "desc": "'A' (ask/blue) or 'B' (bid/red)"
                },
                {
                    "name": "depth_qty_rest",
                    "type": "double",
                    "required": true,
                    "desc": "Resting depth (orders >500ms old). Used for intensity."
                }
            ],
            "frontend_usage": {
                "component": "renderer.ts:updateWall",
                "purpose": "Blue/red liquidity heatmap. Intensity = log1p(depth_qty_rest). d1/d2 are zeroed because stream omits them."
            }
        },
        "vacuum": {
            "description": "Vacuum Physics. Normalized pull forces indicating liquidity erosion.",
            "rows_per_window": "variable (one per active price level within ±400 ticks)",
            "spatial": true,
            "fields": [
                {
                    "name": "window_end_ts_ns",
                    "type": "long",
                    "required": true,
                    "desc": "Window timestamp"
                },
                {
                    "name": "rel_ticks",
                    "type": "int",
                    "required": true,
                    "desc": "Ticks from spot"
                },
                {
                    "name": "vacuum_score",
                    "type": "double",
                    "required": true,
                    "desc": "Normalized 0-1. Higher = more vacuum (liquidity eroding)."
                }
            ],
            "frontend_usage": {
                "component": "renderer.ts:updateVacuum",
                "purpose": "Black overlay on wall. Alpha = vacuum_score * 128. Turbulence/erosion default to 0 because stream omits them."
            }
        },
        "physics": {
            "description": "Per-tick physics score (ease of movement).",
            "rows_per_window": "variable (usually ~60-100 ticks around spot)",
            "spatial": true,
            "fields": [
                {
                    "name": "window_end_ts_ns",
                    "type": "long",
                    "required": true,
                    "desc": "Window timestamp"
                },
                {
                    "name": "rel_ticks",
                    "type": "int",
                    "required": true,
                    "desc": "Ticks from spot"
                },
                {
                    "name": "physics_score",
                    "type": "double",
                    "required": true,
                    "desc": "Absolute physics score 0..1"
                },
                {
                    "name": "physics_score_signed",
                    "type": "double",
                    "required": true,
                    "desc": "+ve for upward ease, -ve for downward ease"
                }
            ],
            "frontend_usage": {
                "component": "renderer.ts:updatePhysics, state.ts:setPhysicsData",
                "purpose": "Directional pressure gradient layer. Cyan above spot = easy to move up. Blue below spot = easy to move down."
            }
        },
        "gex": {
            "description": "Gamma Exposure surface from 0DTE options.",
            "rows_per_window": 25,
            "spatial": true,
            "grid": "±60 points from spot in 5-point steps",
            "fields": [
                {
                    "name": "window_end_ts_ns",
                    "type": "long",
                    "required": true,
                    "desc": "Window timestamp"
                },
                {
                    "name": "strike_points",
                    "type": "double",
                    "required": true,
                    "desc": "Strike price for Y-axis"
                },
                {
                    "name": "underlying_spot_ref",
                    "type": "double",
                    "required": true,
                    "desc": "Futures spot. Used if snap missing."
                },
                {
                    "name": "spot_ref_price_int",
                    "type": "long",
                    "required": true,
                    "desc": "Tick-aligned spot anchor (integer, 20-tick grid)."
                },
                {
                    "name": "rel_ticks",
                    "type": "int",
                    "required": true,
                    "desc": "Ticks relative to spot_ref_price_int (multiples of 20 for ES)."
                },
                {
                    "name": "gex_call_abs",
                    "type": "double",
                    "required": true,
                    "desc": "Absolute call GEX."
                },
                {
                    "name": "gex_put_abs",
                    "type": "double",
                    "required": true,
                    "desc": "Absolute put GEX."
                },
                {
                    "name": "gex_abs",
                    "type": "double",
                    "required": true,
                    "desc": "Absolute GEX. Used for intensity."
                },
                {
                    "name": "gex",
                    "type": "double",
                    "required": true,
                    "desc": "Signed GEX. Positive=call-heavy, negative=put-heavy."
                },
                {
                    "name": "gex_imbalance_ratio",
                    "type": "double",
                    "required": true,
                    "desc": "-1 to +1. Positive=call-heavy (magenta), negative=put-heavy (green)."
                },
                {
                    "name": "d1_gex_abs",
                    "type": "double",
                    "required": true,
                    "desc": "1st derivative of gex_abs."
                },
                {
                    "name": "d2_gex_abs",
                    "type": "double",
                    "required": true,
                    "desc": "2nd derivative of gex_abs."
                },
                {
                    "name": "d3_gex_abs",
                    "type": "double",
                    "required": true,
                    "desc": "3rd derivative of gex_abs."
                },
                {
                    "name": "d1_gex",
                    "type": "double",
                    "required": true,
                    "desc": "1st derivative of gex."
                },
                {
                    "name": "d2_gex",
                    "type": "double",
                    "required": true,
                    "desc": "2nd derivative of gex."
                },
                {
                    "name": "d3_gex",
                    "type": "double",
                    "required": true,
                    "desc": "3rd derivative of gex."
                },
                {
                    "name": "d1_gex_imbalance_ratio",
                    "type": "double",
                    "required": true,
                    "desc": "1st derivative of gex_imbalance_ratio."
                },
                {
                    "name": "d2_gex_imbalance_ratio",
                    "type": "double",
                    "required": true,
                    "desc": "2nd derivative of gex_imbalance_ratio."
                },
                {
                    "name": "d3_gex_imbalance_ratio",
                    "type": "double",
                    "required": true,
                    "desc": "3rd derivative of gex_imbalance_ratio."
                }
            ],
            "frontend_usage": {
                "component": "renderer.ts:createHeatmap, state.ts:setGexData",
                "purpose": "GEX heatmap overlay. Magenta=calls, Green=puts."
            }
        },
        "gex_flow": {
            "description": "Strike-aligned options flow surface (25 rows/window).",
            "rows_per_window": 25,
            "spatial": true,
            "grid": "±60 points from spot in 5-point steps",
            "fields": [
                {
                    "name": "window_end_ts_ns",
                    "type": "long",
                    "required": true,
                    "desc": "Window timestamp"
                },
                {
                    "name": "strike_points",
                    "type": "double",
                    "required": true,
                    "desc": "Strike price for Y-axis"
                },
                {
                    "name": "spot_ref_price_int",
                    "type": "long",
                    "required": true,
                    "desc": "Tick-aligned spot anchor (integer, 20-tick grid)."
                },
                {
                    "name": "rel_ticks",
                    "type": "int",
                    "required": true,
                    "desc": "Ticks relative to spot_ref_price_int (multiples of 20 for ES)."
                },
                {
                    "name": "flow_abs",
                    "type": "double",
                    "required": true,
                    "desc": "Total flow magnitude (add+pull+fill)."
                },
                {
                    "name": "flow_reinforce",
                    "type": "double",
                    "required": true,
                    "desc": "Net reinforcement (add - pull - fill)."
                },
                {
                    "name": "flow_abs_norm",
                    "type": "double",
                    "required": true,
                    "desc": "0..1 normalized flow magnitude."
                },
                {
                    "name": "flow_reinforce_norm",
                    "type": "double",
                    "required": true,
                    "desc": "0..1 normalized reinforcement."
                },
                {
                    "name": "pull_rest_intensity",
                    "type": "double",
                    "required": true,
                    "desc": "Pull rest intensity (pull_rest_qty_sum / depth_total_sum)."
                },
                {
                    "name": "pull_rest_intensity_norm",
                    "type": "double",
                    "required": true,
                    "desc": "0..1 normalized pull rest intensity."
                },
                {
                    "name": "add_qty_sum",
                    "type": "double",
                    "required": true
                },
                {
                    "name": "pull_qty_sum",
                    "type": "double",
                    "required": true
                },
                {
                    "name": "fill_qty_sum",
                    "type": "double",
                    "required": true
                },
                {
                    "name": "pull_rest_qty_sum",
                    "type": "double",
                    "required": true
                },
                {
                    "name": "depth_total_sum",
                    "type": "double",
                    "required": true
                }
            ],
            "frontend_usage": {
                "component": "TBD (Swift Physics Lab)",
                "purpose": "Strike-grid flow surface for obstacle thickening/erosion."
            }
        },
        "bucket_radar": {
            "description": "Bucket-native Physics Radar. 2-tick buckets aligned to spot.",
            "rows_per_window": "variable (usually ~60 buckets around spot)",
            "spatial": true,
            "fields": [
                {
                    "name": "window_end_ts_ns",
                    "type": "long",
                    "required": true,
                    "desc": "Window timestamp"
                },
                {
                    "name": "bucket_rel",
                    "type": "int",
                    "required": true,
                    "desc": "Bucket index relative to spot (0=spot). 1 bucket = 2 ticks."
                },
                {
                    "name": "blocked_level",
                    "type": "int",
                    "required": true,
                    "desc": "0..5 integer resistance level."
                },
                {
                    "name": "cavitation",
                    "type": "double",
                    "required": true,
                    "desc": "0..1 vacuum visibility."
                },
                {
                    "name": "gex_stiffness",
                    "type": "double",
                    "required": true,
                    "desc": "0..1 gamma barrier strength."
                },
                {
                    "name": "mobility",
                    "type": "double",
                    "required": true,
                    "desc": "0..1 ease of movement."
                }
            ],
            "frontend_usage": {
                "component": "renderer.ts:updateBucketRadar",
                "purpose": "Primary visualization layer. Blocked=resistance, Cavitation=vacuum."
            }
        },
        "options_wall": {
            "description": "Options Liquidity Wall. Granular book depth per instrument/price.",
            "rows_per_window": "variable",
            "spatial": true,
            "fields": [
                {
                    "name": "window_end_ts_ns",
                    "type": "long",
                    "required": true
                },
                {
                    "name": "instrument_id",
                    "type": "long",
                    "required": true,
                    "desc": "Option instrument id"
                },
                {
                    "name": "side",
                    "type": "string",
                    "required": true,
                    "desc": "'A' or 'B'"
                },
                {
                    "name": "price_int",
                    "type": "long",
                    "required": true,
                    "desc": "Option premium price (scaled int)"
                },
                {
                    "name": "depth_total",
                    "type": "long",
                    "required": true,
                    "desc": "Aggregated depth"
                },
                {
                    "name": "pull_rest_qty",
                    "type": "long",
                    "required": true,
                    "desc": "Resting liquidity pulled"
                }
            ],
            "frontend_usage": {
                "component": "TBD",
                "purpose": "Visualizes granular options liquidity barriers."
            }
        },
        "options_flow": {
            "description": "Options Layout Flow. Aggressive flow metrics per instrument/price.",
            "rows_per_window": "variable",
            "spatial": true,
            "fields": [
                {
                    "name": "window_end_ts_ns",
                    "type": "long",
                    "required": true
                },
                {
                    "name": "instrument_id",
                    "type": "long",
                    "required": true
                },
                {
                    "name": "side",
                    "type": "string",
                    "required": true
                },
                {
                    "name": "price_int",
                    "type": "long",
                    "required": true
                },
                {
                    "name": "add_qty",
                    "type": "long",
                    "required": true
                },
                {
                    "name": "pull_qty",
                    "type": "long",
                    "required": true
                },
                {
                    "name": "fill_qty",
                    "type": "long",
                    "required": true
                }
            ],
            "frontend_usage": {
                "component": "TBD",
                "purpose": "Visualizes aggressive flow (attacks) on gamma levels."
            }
        }
    },
    "constants": {
        "PRICE_SCALE": 1e-9,
        "TICK_SIZE": 0.25,
        "TICK_INT": 250000000,
        "WINDOW_NS": 1000000000,
        "HUD_STREAM_MAX_TICKS": 400
    }
}
